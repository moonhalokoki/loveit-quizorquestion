<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Kawaii OS - Ultimate Backup</title>
    <link
      rel="apple-touch-icon"
      href="https://i.postimg.cc/d30hx819/IMG-5616.jpg"
    />
    <link
      rel="icon"
      type="image/jpg"
      href="https://i.postimg.cc/d30hx819/IMG-5616.jpg"
    />
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.7);
            --shadow: 0 8px 20px rgba(255, 183, 206, 0.25);
            --radius-lg: 32px;
            --main-font: "Nunito", "PingFang SC", sans-serif;
            --primary-color: #007aff;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --chat-bubble-self: #007aff;
            --chat-bubble-other: #ffffff;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }

        body {
            margin: 0; padding: 0;
            background: linear-gradient(180deg, #fff5f8 0%, #ffeaf3 100%);
            background-size: cover; background-position: center; background-attachment: fixed;
            font-family: var(--main-font);
            font-size: 20px
            height: 100vh; overflow: hidden; color: #666;
            display: flex; flex-direction: column; position: relative;
        }

        #toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px;
            border-radius: 50px; z-index: 10001; font-size: 14px; font-weight: bold;
            display: none; pointer-events: none; backdrop-filter: blur(5px);
        }

        .container {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            padding: 20px 24px;
            padding-top: calc(80px + env(safe-area-inset-top)); 
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .container.pushed { transform: scale(0.9); opacity: 0; pointer-events: none; }

        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: var(--radius-lg); box-shadow: var(--shadow);
            overflow: hidden;
        }

        /* æ¡Œé¢ç»„ä»¶ */
        .home-widget { height: 32vh; margin-bottom: 60px; width: 100%; position: relative; display: flex; flex-direction: column; z-index: 10; }
        .widget-cover { height: 45%; width: 100%; background: rgba(255, 183, 206, 0.3); position: relative; cursor: pointer; }
        .widget-cover img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cover-hint { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size: 10px; color:rgba(255,255,255,0.8); pointer-events: none; }
        .widget-body { height: 55%; width: 100%; position: relative; display: flex; flex-direction: column; align-items: center; padding-top: 45px; cursor: pointer; }
        .widget-body-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.5; z-index: 0; pointer-events: none; }
        .avatar-wrapper { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); width: 86px; height: 86px; border-radius: 50%; background: #fff; padding: 3px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); z-index: 5; cursor: pointer; }
        .avatar-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .info-content { z-index: 2; text-align: center; width: 90%; }
        .user-name { font-size: 18px; font-weight: 800; margin-bottom: 6px; color: #444; }
        .bio-text { font-size: 12px; margin: 2px 0; opacity: 0.9; }
        .tag-pill { display: inline-block; background: rgba(255,255,255,0.8); padding: 4px 12px; border-radius: 12px; font-size: 10px; margin-top: -5px; color: #ff9eb5; font-weight: bold; }
        .top-btn { position: absolute; top: 12px; right: 12px; width: 28px; height: 28px; background: rgba(255,255,255,0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; z-index: 10; cursor: pointer; }
        
        .middle-row { display: flex; gap: 16px; width: 100%; margin-bottom: auto; padding-bottom: 50px }
        .square-widget { flex: 1; aspect-ratio: 1 / 1; padding: 0; position: relative; cursor: pointer; border-radius: var(--radius-lg); }
        .square-widget img { width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-lg); }
        .app-grid { flex: 1; aspect-ratio: 1 / 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 12px; padding: 4px; }
        .app-item { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .app-item:active { transform: scale(0.95); transition: 0.1s; }
        
        .app-icon { 
            width: 56px; height: 56px; 
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 12px rgba(255, 183, 206, 0.3); 
            margin-bottom: 6px; overflow: hidden; 
        }
        .app-icon img { width: 100%; height: 100%; object-fit: cover; }
        .app-label { font-size: 11px; font-weight: 600; color: #777; }
        .svg-icon { width: 26px; height: 26px; fill: #ffb7ce; }
        
        /* ğŸ”¥ Dock æ ä½ç½®è°ƒæ•´ */
        .dock { 
            height: 110px; 
            border-radius: 40px; 
            display: flex; justify-content: space-evenly; align-items: center; 
            padding: 0 10px; flex-shrink: 0; 
            margin-top: auto; 
            margin-bottom: 15px; /* ğŸ”¥ åœ¨è¿™é‡Œä¿®æ”¹Dockç¦»åº•éƒ¨çš„è·ç¦»ï¼Œæ•°å­—è¶Šå¤§è¶Šé ä¸Š */
        }
        .dock-app { display: flex; flex-direction: column; align-items: center; width: 60px; cursor: pointer; }
        .dock-box { 
            width: 56px; height: 56px; 
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px; 
            display: flex; align-items: center; justify-content: center; 
            margin-bottom: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); overflow: hidden; 
        }
        .dock-box img { width: 100%; height: 100%; object-fit: cover; }
        
        input[type="file"] { display: none; }
        [contenteditable]:focus { outline: none; background: rgba(255,255,255,0.5); }

        /* --- å…¨å± APP --- */
        .fullscreen-app {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f2f2f7; z-index: 2000;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
        }
        .fullscreen-app.active { transform: translateX(0); }
        
        #chatListApp { z-index: 2010; }
        #profileApp { z-index: 2020; background: #fff; }
        #worldbookApp { z-index: 2025; background: #fff; }
        #chatWindowApp { z-index: 2030; background: #efeff4; }
        #interactApp { z-index: 2100; background: #000; display: none; } 
        #interactApp.active { display: flex; }
        #interactSettingsApp { z-index: 2200; background: #fff; } 
        
        #interactSelector { 
            z-index: 2050; background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); 
            display: none; justify-content: center; align-items: center; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        }
        #interactSelector.active { display: flex; }
        
        .selector-card { background: #fff; width: 85%; max-width: 320px; border-radius: 24px; padding: 20px; max-height: 60vh; overflow-y: auto; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .selector-item { display: flex; align-items: center; padding: 12px 10px; border-bottom: 1px solid #f7f7f7; cursor: pointer; border-radius: 12px; transition: 0.2s; }
        .selector-item:active { background: #f0f0f0; transform: scale(0.98); }
        .selector-item:last-child { border-bottom: none; }
        .selector-avatar { width: 44px; height: 44px; border-radius: 50%; margin-right: 15px; object-fit: cover; background: #eee; border: 1px solid #f0f0f0; }
        .selector-name { font-size: 16px; font-weight: 700; color: #333; }
        .selector-close { position: absolute; top: 20px; right: 20px; width: 30px; height: 30px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff; cursor: pointer; z-index: 2051; pointer-events: auto; }

        .app-header {
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            height: 50px; padding-top: env(safe-area-inset-top);
            display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; box-sizing: content-box;
            position: relative; z-index: 10;
        }
        .header-back { position: absolute; left: 15px; color: var(--primary-color); font-size: 16px; display: flex; align-items: center; cursor: pointer; z-index: 11; padding: 10px; }
        .header-title { font-weight: bold; font-size: 17px; display:flex; flex-direction:column; align-items:center; line-height:1.1; }
        .header-status { font-size: 10px; color: #888; font-weight: normal; margin-top: 2px; }
        .header-right { position: absolute; right: 15px; color: var(--primary-color); font-size: 16px; cursor: pointer; z-index: 11; padding: 10px; }

        .settings-content { flex: 1; overflow-y: auto; padding: 20px; }
        .settings-group { background: #fff; border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f0f0f0; font-size: 16px; }
        .list-item:last-child { border-bottom: none; }
        .list-label { display: flex; align-items: center; gap: 10px; }
        .text-input { border: none; background: #f0f0f0; padding: 8px; border-radius: 8px; width: 100%; margin-right: 10px; font-size: 14px; }
        .btn-upload { background: #f0f0f0; color: var(--primary-color); border: none; padding: 6px 12px; border-radius: 15px; font-size: 13px; cursor: pointer; }
        
        .icon-preview { width: 30px; height: 30px; border-radius: 8px; background: rgba(0,0,0,0.1); backdrop-filter: blur(4px); overflow: hidden; border:1px solid #eee; }
        .icon-preview img { width: 100%; height: 100%; object-fit: contain; }
        
        .btn-action-row { display: flex; gap: 10px; margin-top: 10px; justify-content: center; flex-wrap: wrap; }
        .btn-mini { padding: 10px 20px; border-radius: 20px; font-size: 14px; border: none; cursor: pointer; font-weight: bold; flex-shrink: 0; }
        .btn-export { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }
        .btn-import { background: #e8f5e9; color: #43a047; }
        .btn-clear { background: #ffebee; color: #e53935; }

        /* --- ğŸ“š ä¸–ç•Œä¹¦ç‰¹æœ‰æ ·å¼ --- */
        .wb-grid { display: grid; gap: 15px; }
        .wb-card { background: #f9f9f9; padding: 15px; border-radius: 16px; border: 1px solid #eee; display:flex; flex-direction:column; gap:10px; position: relative; }
        .wb-header { display:flex; flex-direction:column; gap: 5px; }
        .wb-title-row { display:flex; justify-content:space-between; align-items:center; gap: 10px; }
        .wb-title-input { font-size: 18px; font-weight: bold; background: transparent; border:none; width: 100%; border-bottom: 1px solid transparent; }
        .wb-title-input:focus { border-bottom: 1px solid #ddd; }
        .wb-entries { display: flex; flex-direction: column; gap: 8px; max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .wb-card.open .wb-entries { max-height: 1000px; padding-top: 10px; border-top: 1px dashed #ddd; }
        .wb-entry-row { display: flex; gap: 8px; align-items: flex-start; }
        .wb-entry-key { flex: 1; background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 8px; font-size: 12px; font-weight: bold; }
        .wb-entry-val { flex: 3; background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 8px; font-size: 12px; min-height: 34px; resize: vertical; }
        
        .btn-icon { width: 30px; height: 30px; display:flex; align-items:center; justify-content:center; border-radius:50%; border:none; cursor:pointer; font-size:14px; flex-shrink:0; }
        .btn-del { background: #ffebee; color: #e53935; }
        .btn-add { background: #e8f5e9; color: #34c759; margin-top: 5px; width: 100%; border-radius: 8px; }
        .wb-toggle { position: absolute; top: 15px; right: 15px; transform: rotate(0deg); transition: 0.3s; color: var(--primary-color); cursor:pointer; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; }
        .wb-card.open .wb-toggle { transform: rotate(180deg); }
        
        .wb-mode-btn { font-size: 10px; padding: 4px 8px; border-radius: 10px; cursor: pointer; border: 1px solid #ddd; background: #fff; color: #666; width: fit-content; }
        .wb-mode-btn.always { background: #e3f2fd; color: #007aff; border-color: #007aff; }
        .wb-mode-btn.keyword { background: #fff3e0; color: #f57c00; border-color: #f57c00; }
        
        .modal-checkbox-list { text-align: left; max-height: 200px; overflow-y: auto; margin: 10px 0; border: 1px solid #f0f0f0; border-radius: 8px; padding: 5px; }
        .checkbox-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f9f9f9; cursor: pointer; }
        .checkbox-item input { margin-right: 10px; accent-color: var(--primary-color); }

        /* --- ğŸ’¬ èŠå¤©åˆ—è¡¨ & å·¦æ»‘åˆ é™¤ --- */
        .chat-list-container, .friend-list-container { flex: 1; overflow-y: auto; background: #fff; overflow-x: hidden; width: 100%; }
        .chat-swipe-wrapper { position: relative; overflow: hidden; border-bottom: 1px solid #f5f5f5; height: 74px; }
        .chat-delete-action {
            position: absolute; top: 0; right: 0; bottom: 0; width: 80px;
            background: var(--danger-color); color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; z-index: 1;
            cursor: pointer; pointer-events: auto;
        }
        .chat-item {
            display: flex; align-items: center; padding: 12px 15px; height: 74px;
            background: #fff; position: relative; width:100%; z-index: 2;
            transition: transform 0.2s ease-out;
            cursor: pointer; border-bottom: 1px solid #f9f9f9;
        }
        .chat-item:active { background: #f2f2f7; }
        .chat-avatar { width: 50px; height: 50px; border-radius: 50%; background: #eee; margin-right: 12px; flex-shrink: 0; overflow: hidden; }
        .chat-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .chat-content { flex: 1; min-width: 0; }
        .chat-top-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .chat-name { font-size: 16px; font-weight: 600; color: #333; }
        .chat-time { font-size: 12px; color: #bbb; }
        .chat-preview { font-size: 14px; color: #8e8e93; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .friend-bio { font-size: 12px; color: #999; margin-top: 2px; }

        .bottom-nav { height: 50px; border-top: 1px solid #eee; background: #fff; display: flex; padding-bottom: env(safe-area-inset-bottom); }
        .nav-tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; cursor: pointer; }
        .nav-tab.active { color: var(--primary-color); }
        .nav-icon { width: 24px; height: 24px; margin-bottom: 2px; fill: currentColor; }

        /* --- ğŸ—¨ï¸ èŠå¤©çª—å£ --- */
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; background-size: cover; background-position: center; padding-bottom: 20px; }
        
        .msg-row { display: flex; align-items: flex-start; margin-bottom: 5px; animation: fadeIn 0.3s ease; position: relative; }
        .msg-row.self { justify-content: flex-end; }
        
        .selection-mode .msg-row { cursor: pointer; opacity: 0.9; }
        .selection-mode .msg-row::before {
            content: ''; display: block; width: 22px; height: 22px; border: 2px solid #ccc; border-radius: 50%;
            margin-right: 10px; align-self: center; flex-shrink: 0; background: #fff;
        }
        .selection-mode .msg-row.selected::before {
            background: var(--primary-color); border-color: var(--primary-color);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='14px' height='14px'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: center;
        }
        .selection-mode .chat-footer-wrapper { display: none; }
        .selection-bar {
            height: 50px; background: #fff; border-top: 1px solid #eee;
            display: none; align-items: center; justify-content: space-between; padding: 0 20px;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .selection-mode .selection-bar { display: flex; }
        .btn-delete-msgs { color: var(--danger-color); font-weight: bold; cursor: pointer; }

        .avatar-container { display: flex; flex-direction: column; align-items: center; margin: 0 8px; flex-shrink: 0; }
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; overflow: hidden; background: #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .msg-time { font-size: 9px; color: #999; margin-top: 4px; display: none; text-align: center; width: 100%; }
        .show-time .msg-time { display: block; }

        .msg-bubble-wrapper { max-width: 72%; display: flex; flex-direction: column; }
        .msg-bubble { width: fit-content; display: flex; }
        .msg-content {
            padding: 10px 14px; border-radius: 18px; font-size: 16px; line-height: 1.5;
            word-break: break-word; white-space: pre-wrap; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .msg-row.other .msg-content { background: var(--chat-bubble-other); color: #000; border-top-left-radius: 4px; }
        .msg-row.self .msg-content { background: var(--chat-bubble-self); color: #fff; border-top-right-radius: 4px; }
        .msg-row.self .msg-bubble-wrapper { align-items: flex-end; }

        .msg-sticker { max-width: 140px; border-radius: 12px; display: block; }
        .msg-img { max-width: 100%; border-radius: 12px; display: block; cursor: pointer; }
        .msg-fake-img-box {
            width: 120px; height: 120px; background: #eee; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; color: #999;
            flex-direction: column; cursor: pointer; border: 1px solid #ddd;
        }
        
        .msg-voice-box {
            padding: 5px 10px; display: flex; align-items: center; gap: 8px; cursor: pointer; min-width: 70px;
            user-select: none; transition: opacity 0.2s; pointer-events: auto;
        }
        .msg-voice-box:active { opacity: 0.6; }
        .voice-icon { font-size: 16px; }

        .chat-footer-wrapper {
            background: #f9f9f9; border-top: 1px solid #ddd;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column;
        }
        .chat-toolbar {
            display: flex; padding: 10px 12px 2px 12px; gap: 18px; overflow-x: auto;
        }
        .tool-btn {
            width: 32px; height: 32px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            background: #fff; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .tool-btn svg { width: 20px; height: 20px; fill: #666; }
        
        .chat-input-bar { padding: 8px 10px; display: flex; align-items: flex-end; gap: 8px; }
        .chat-input { flex: 1; min-height: 38px; max-height: 100px; padding: 8px 14px; border-radius: 19px; border: 1px solid #ddd; background: #fff; font-size: 16px; resize: none; font-family: inherit; }
        
        .send-group { display: flex; gap: 5px; flex-shrink: 0; }
        .btn-ai, .btn-send {
            width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; cursor: pointer; font-size: 16px; font-weight: bold;
        }
        .btn-ai { background: #ff9eb5; box-shadow: 0 2px 5px rgba(255,158,181,0.4); }
        .btn-send { background: var(--primary-color); box-shadow: 0 2px 5px rgba(0,122,255,0.4); }

        /* --- ğŸ†” èµ„æ–™å¡ --- */
        .profile-container { height: 100%; overflow-y: auto; background: #fff; padding-bottom: 20px; }
        .profile-cover { height: 260px; width: 100%; background: #ccc; position: relative; overflow: hidden; }
        .profile-cover img { width: 100%; height: 100%; object-fit: cover; }
        .profile-back { position: absolute; top: calc(10px + env(safe-area-inset-top)); left: 15px; color: white; z-index: 10; font-size: 24px; text-shadow: 0 1px 3px rgba(0,0,0,0.5); cursor: pointer; padding: 10px; }
        .profile-card { position: relative; margin-top: -40px; border-top-left-radius: 20px; border-top-right-radius: 20px; background: #fff; padding: 15px 20px; min-height: 500px; }
        .profile-avatar-wrap { position: absolute; top: -45px; left: 20px; width: 90px; height: 90px; border-radius: 50%; padding: 4px; background: #fff; z-index: 5; }
        .profile-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: #eee; cursor: pointer; border: 1px solid #eee; }
        .profile-info { margin-top: 45px; }
        .profile-name-row { display: flex; justify-content: space-between; align-items: baseline; }
        .profile-name { font-size: 24px; font-weight: 800; color: #333; margin-bottom: 5px; }
        .profile-status { font-size: 12px; color: #888; }
        .tag-row { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
        .info-tag { background: #f0f0f0; color: #666; font-size: 12px; padding: 4px 10px; border-radius: 12px; display: inline-flex; align-items: center; }
        .info-tag.editable:empty::before { content: 'ç‚¹å‡»ç¼–è¾‘'; opacity: 0.5; }
        .profile-signature { color: #333; font-size: 14px; margin-top: 10px; line-height: 1.5; padding: 10px; background: #f9f9f9; border-radius: 10px; }
        .section-title { font-size: 14px; color: #999; margin: 25px 0 10px 0; font-weight: bold; }
        .persona-box { background: #f5f5f5; padding: 12px; border-radius: 12px; font-size: 14px; color: #333; line-height: 1.5; min-height: 60px; }
        .user-persona-section { display: flex; gap: 15px; margin-top: 10px; }
        .user-persona-avatar { width: 60px; height: 60px; border-radius: 12px; background: #eee; flex-shrink: 0; overflow: hidden; cursor: pointer; }
        .user-persona-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-persona-text { flex: 1; background: #f5f5f5; padding: 10px; border-radius: 12px; font-size: 13px; }
        .profile-actions { display: flex; gap: 15px; margin-top: 30px; margin-bottom: 30px; }
        .action-btn { flex: 1; padding: 12px; border-radius: 25px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; }
        .btn-save { background: #f0f0f0; color: #333; }
        .btn-chat { background: var(--primary-color); color: #fff; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }
        .wb-tags-display { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; min-height: 24px; }
        .wb-tag { background: #e3f2fd; color: #1976d2; font-size: 10px; padding: 3px 8px; border-radius: 10px; }

        /* --- ğŸŒ¸ äº’åŠ¨æ¨¡å¼ (VN) --- */
        .vn-container { width:100%; height:100%; position:relative; overflow:hidden; }
        .vn-bg { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:1; }
        .vn-tachie { 
            position:absolute; bottom:0; left:50%; transform:translateX(-50%); 
            height:90%; z-index:2; pointer-events:none; transition: all 0.3s;
        }
        
        .vn-textbox {
            position:absolute; bottom:20px; left:10px; right:10px;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            border-radius: 15px; padding: 15px; z-index: 10; color:white;
            border: 2px solid rgba(255,255,255,0.2);
            transition: opacity 0.3s;
            cursor: pointer; pointer-events: auto;
        }
        .vn-textbox.hidden { opacity: 0; pointer-events: none; }
        
        .vn-input-wrapper { display: none; margin-top: 10px; gap: 10px; }
        .vn-input-wrapper.active { display: flex; }
        .vn-input { flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px; border-radius: 8px; }
        
        .vn-ai-btn, .vn-send-btn { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; font-size: 16px; font-weight: bold; border:none; }
        .vn-ai-btn { background: #ff9eb5; box-shadow: 0 2px 5px rgba(255,158,181,0.4); margin-right: 5px;}
        .vn-send-btn { background: var(--primary-color); box-shadow: 0 2px 5px rgba(0,122,255,0.4); }

        .vn-name { font-weight: bold; font-size: 16px; color: #ff9eb5; margin-bottom: 5px; }
        .vn-text { font-size: 15px; line-height: 1.5; min-height: 24px; }
        
        .vn-ui-layer { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 20; pointer-events: none; }
        .vn-btn {
            position: absolute; pointer-events: auto; background: rgba(255,255,255,0.9);
            width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center;
            align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); color: #333; font-size: 20px;
            top: calc(20px + env(safe-area-inset-top)); cursor: pointer;
        }
        .vn-btn-back { left: 20px; }
        .vn-btn-hide { right: 70px; }
        .vn-btn-set { right: 20px; }
        
        .vn-control-bar { position: absolute; top: calc(20px + env(safe-area-inset-top)); right: 10px; display: flex; gap: 10px; pointer-events: auto; }
        .vn-btn-toggle-input { position: absolute; right: 10px; top: calc(25px + env(safe-area-inset-top)); width: 30px; height: 30px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; pointer-events: auto; }
        .vn-history-btn { position: absolute; right: 20px; bottom: 100px; width: 40px; height: 40px; background: rgba(255,255,255,0.8); border-radius: 50%; color: #333; display: flex; justify-content: center; align-items: center; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); pointer-events: auto; z-index: 15; }

        #vnHistoryPanel { position: absolute; top: 0; right: 0; width: 80%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 30; transform: translateX(100%); transition: transform 0.3s; padding: 20px; overflow-y: auto; color: white; pointer-events: auto; }
        #vnHistoryPanel.active { transform: translateX(0); }
        .vn-hist-item { margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .vn-hist-name { font-weight: bold; color: #ff9eb5; font-size: 12px; margin-bottom: 4px; }
        .vn-hist-content { font-size: 14px; line-height: 1.4; }

        /* æ¨¡æ€å¼¹çª—é€šç”¨ */
        #custom-modal-overlay, #sprite-upload-overlay, #worldbook-select-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); z-index: 9999; display: none; align-items: center; justify-content: center; }
        #custom-modal-box { background: rgba(255,255,255,0.95); width: 80%; max-width: 320px; border-radius: 20px; padding: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.2s; }
        #custom-modal-overlay.active, #sprite-upload-overlay.active, #worldbook-select-overlay.active { display: flex; }
        #custom-modal-overlay.active #custom-modal-box, #sprite-upload-overlay.active #custom-modal-box, #worldbook-select-overlay.active #custom-modal-box { transform: scale(1); }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #333; }
        .modal-desc { font-size: 14px; color: #666; margin-bottom: 20px; line-height: 1.5; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 20px; font-size: 16px; background: #f9f9f9; display: none; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { flex: 1; padding: 10px 0; border-radius: 12px; font-size: 15px; border: none; cursor: pointer; }
        .btn-cancel { background: #f0f0f0; color: #666; }
        .btn-confirm { background: var(--primary-color); color: white; font-weight: bold; }
        .btn-danger { background: var(--danger-color); color: white; font-weight: bold; }
        
        .sticker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 200px; overflow-y: auto; padding: 5px; }
        .sticker-item { aspect-ratio: 1; background: #fff; border-radius: 12px; overflow: hidden; cursor: pointer; position: relative; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .sticker-item img { width: 100%; height: 100%; object-fit: cover; }

        /* äº’åŠ¨èµ„æºç½‘æ ¼ */
        .asset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-height: 200px; overflow-y: auto; padding: 5px; }
        .asset-item { position: relative; aspect-ratio: 2/3; background: #eee; border-radius: 8px; overflow: hidden; cursor: pointer; border: 2px solid transparent; }
        .asset-item.active { border-color: var(--primary-color); }
        .asset-item img { width: 100%; height: 100%; object-fit: cover; }
        .asset-name { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; font-size: 10px; padding: 2px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .sprite-input-group { text-align: left; margin-bottom: 15px; }
        .sprite-input-label { font-size: 12px; color: #888; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

    <!-- ğŸŒ¸ å¼¹çª—ä¸æç¤º -->
    <div id="custom-modal-overlay">
        <div id="custom-modal-box">
            <div class="modal-title" id="modal-title">æç¤º</div>
            <div class="modal-desc" id="modal-desc">å†…å®¹</div>
            <input type="text" id="modal-input" class="modal-input" placeholder="è¯·è¾“å…¥...">
            <div id="sticker-area" style="display:none;" class="sticker-grid"></div> 
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" id="btn-cancel">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" id="btn-confirm">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <!-- ğŸ”¥ ç«‹ç»˜ä¸Šä¼ å¼¹çª— -->
    <div id="sprite-upload-overlay">
        <div id="custom-modal-box">
            <div class="modal-title">ä¸Šä¼ ç«‹ç»˜</div>
            <div class="modal-desc">è¯·å®šä¹‰è¿™å¼ å›¾çš„æœè£…å’Œè¡¨æƒ…</div>
            <div class="sprite-input-group"><span class="sprite-input-label">æœè£…å (ID) - å¦‚: suit, casual</span><input type="text" id="sprite-outfit-input" class="modal-input" style="display:block; margin-bottom:5px;" placeholder="ä¾‹ï¼šsuit"></div>
            <div class="sprite-input-group"><span class="sprite-input-label">è¡¨æƒ…å (ID) - å¦‚: smile, angry</span><input type="text" id="sprite-face-input" class="modal-input" style="display:block; margin-bottom:5px;" placeholder="ä¾‹ï¼šnormal"></div>
            <div class="modal-btns"><button class="modal-btn btn-cancel" onclick="closeSpriteModal()">å–æ¶ˆ</button><button class="modal-btn btn-confirm" id="btn-confirm-sprite">ç¡®å®šä¿å­˜</button></div>
        </div>
    </div>

    <!-- ğŸ“š ä¸–ç•Œä¹¦é€‰æ‹©å¼¹çª— -->
    <div id="worldbook-select-overlay">
        <div id="custom-modal-box">
            <div class="modal-title">ç»‘å®šä¸–ç•Œä¹¦</div>
            <div class="modal-desc">é€‰æ‹©åœ¨æ­¤å¯¹è¯ä¸­ç”Ÿæ•ˆçš„è®¾å®šé›†</div>
            <div id="wb-select-list" class="modal-checkbox-list"></div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="document.getElementById('worldbook-select-overlay').classList.remove('active')">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="saveWorldbookSelection()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id="toast">ä¿å­˜æˆåŠŸ</div>

    <!-- ğŸŒ¸ å¥½å‹é€‰æ‹©å™¨ -->
    <div id="interactSelector"><div class="selector-card" id="interactList"></div><div class="selector-close" onclick="closeInteractSelector()">Ã—</div></div>

    <!-- ğŸ“– ä¸–ç•Œä¹¦ç®¡ç† APP -->
    <div class="fullscreen-app" id="worldbookApp">
        <div class="app-header">
            <div class="header-back" onclick="closeWorldbookApp()">â€¹ è¿”å›</div>
            <div class="header-title">ä¸–ç•Œä¹¦ç®¡ç†</div>
            <div class="header-right" onclick="createWorldbook()">â•</div>
        </div>
        <div class="settings-content">
            <div id="worldbook-list" class="wb-grid">
                <!-- JS æ¸²æŸ“ -->
            </div>
            <div style="text-align:center; color:#999; font-size:12px; margin-top:20px; padding:0 20px;">
                é»˜è®¤æ¨¡å¼ä¸ºâ€œå§‹ç»ˆç”Ÿæ•ˆâ€ï¼Œæ‰€æœ‰æ¡ç›®éƒ½ä¼šå‘ç»™ AIã€‚ç‚¹å‡»åˆ‡æ¢åˆ°â€œå…³é”®è¯æ£€æµ‹â€å¯èŠ‚çœä¸Šä¸‹æ–‡ã€‚
            </div>
        </div>
    </div>

    <!-- ğŸŒ¸ äº’åŠ¨æ¨¡å¼ -->
    <div class="fullscreen-app" id="interactApp">
        <div class="vn-container">
            <img class="vn-bg" id="vnBg" src="https://via.placeholder.com/400x800/222/fff?text=BG">
            <img class="vn-tachie" id="vnTachie" src="https://via.placeholder.com/300x600/transparent/fff?text=Character">
            <div id="vnHistoryPanel"><div style="text-align:right;margin-bottom:20px;cursor:pointer;" onclick="document.getElementById('vnHistoryPanel').classList.remove('active')">âœ– å…³é—­</div><div id="vnHistoryContent"></div></div>
            <div class="vn-ui-layer">
                <div class="vn-btn vn-btn-back" onclick="closeInteractApp()">â€¹</div>
                <div class="vn-btn vn-btn-hide" onclick="toggleDialogue()">ğŸ‘ï¸</div>
                <div class="vn-btn vn-btn-set" onclick="openVNSettings()">âš™ï¸</div>
                <div class="vn-history-btn" onclick="showVnHistory()">ğŸ“œ</div>
                <div class="vn-textbox" id="vnTextbox">
                    <div class="vn-name" id="vnName">è§’è‰²å</div>
                    <div class="vn-text" id="vnTextContent">ç‚¹å‡»è¿™é‡Œæ¨è¿›å‰§æƒ…...</div>
                    <div class="vn-btn-toggle-input" id="vnToggleBtn" onclick="toggleVnInput(event)">âŒ¨ï¸</div>
                    <div class="vn-input-wrapper" id="vnInputWrapper"><button class="vn-ai-btn" onclick="triggerVnAi(event)">âœ¨</button><input type="text" class="vn-input" id="vnInput" placeholder="è¾“å…¥å¯¹è¯..."><button class="vn-send-btn" id="vnSendBtn" onclick="sendVnUserMessage(event)">â¤</button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸŒ¸ äº’åŠ¨æ¨¡å¼è®¾ç½®é¢æ¿ -->
    <div class="fullscreen-app" id="interactSettingsApp">
        <div class="app-header">
            <div class="header-back" onclick="closeVNSettings()">â€¹ è¿”å›</div>
            <div class="header-title">äº’åŠ¨èµ„æºç®¡ç†</div>
        </div>
        <div class="settings-content">
            <div class="group-title">åœºæ™¯èƒŒæ™¯</div>
            <div class="settings-group"><div class="list-item" style="display:block;"><div class="asset-grid" id="vnBgGrid"></div><button class="btn-upload" style="width:100%;margin-top:10px;" onclick="trigger('vnBgInput')">â• æ·»åŠ æ–°èƒŒæ™¯</button></div></div>
            <div class="group-title">è§’è‰²ç«‹ç»˜</div>
            <div class="settings-group"><div class="list-item" style="display:block;"><div class="asset-grid" id="vnSpriteGrid"></div><button class="btn-upload" style="width:100%;margin-top:10px;" onclick="trigger('vnTachieInput')">â• æ·»åŠ æ–°ç«‹ç»˜</button></div></div>
            <div class="group-title">è‡ªåŠ¨ä½œæ¯è¡¨ (æ—¶é—´/åœ°ç‚¹/æœè£…)</div>
            <div class="settings-group">
                <div class="list-item" style="flex-direction:column; align-items:stretch;">
                    <div id="scheduleList"></div>
                    <div style="margin-top:10px; border-top:1px solid #f0f0f0; padding-top:10px;">
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <select id="schedType" class="text-input" style="flex:1;"><option value="everyday">æ¯å¤©</option><option value="weekday">å·¥ä½œæ—¥ (å‘¨ä¸€è‡³å‘¨äº”)</option><option value="weekend">å‘¨æœ« (å‘¨å…­è‡³å‘¨æ—¥)</option></select>
                            <input type="time" id="schedTime" class="text-input" style="width:100px;">
                        </div>
                        <div style="display:flex; gap:10px;"><input type="text" id="schedOutfit" class="text-input" placeholder="æœè£…ID (å¦‚: suit)"><input type="text" id="schedScene" class="text-input" placeholder="åœºæ™¯å (å¦‚: office)"></div>
                        <button class="btn-mini btn-export" style="width:100%; margin-top:10px;" onclick="addScheduleItem()">æ·»åŠ ä½œæ¯èŠ‚ç‚¹</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="vnBgInput" style="display:none" accept="image/*" onchange="handleVNUpload(this, 'bg')">
    <input type="file" id="vnTachieInput" style="display:none" accept="image/*" onchange="handleSpriteUploadStart(this)">

    <!-- ä¸»å±å¹• -->
    <div class="container" id="desktop">
        <div class="glass-panel home-widget">
            <div class="top-btn" onclick="clearData()">â†»</div>
            <div class="widget-cover" onclick="trigger('coverInput')"><div class="cover-hint" id="coverHint">ç‚¹æ­¤æ¢å°é¢</div><img src="" id="coverImg"></div>
            <div class="avatar-wrapper" onclick="trigger('avatarInput')"><img src="https://ui-avatars.com/api/?name=Melody&background=ffd1dc&color=fff" class="avatar-img" id="avatarImg"></div>
            <div class="widget-body" onclick="trigger('bodyInput')">
                <img src="" class="widget-body-bg" id="bodyBgImg" style="display:none;">
                <div class="info-content" onclick="event.stopPropagation()">
                    <div id="txt_name" class="user-name" contenteditable="true">Melody</div>
                    <div id="txt_bio1" class="bio-text" contenteditable="true">âœ¨ æ¬¢è¿æ¥åˆ° Kawaii OS âœ¨</div>
                    <div id="txt_bio2" class="bio-text" contenteditable="true">Â· Perfect Flow Â·</div>
                    <div id="txt_loc" class="tag-pill" contenteditable="true">ğŸ“ Tokyo</div>
                </div>
            </div>
        </div>

        <div class="middle-row">
            <div class="glass-panel square-widget" onclick="trigger('squareInput')"><img src="https://via.placeholder.com/300/ffd1dc/ffffff?text=Img" id="squareImg"></div>
            <div class="app-grid">
                <div class="app-item" onclick="openChatListApp()"><div class="app-icon" id="icon_chat"><svg class="svg-icon" viewBox="0 0 24 24"><path d="M12,13C10.9,13 10,12.1 10,11C10,9.9 10.9,9 12,9C13.1,9 14,9.9 14,11C14,12.1 13.1,13 12,13M18.5,10C19.3,10 20,10.7 20,11.5V12C20,12.8 19.3,13.5 18.5,13.5H16.5V10H18.5M5.5,10H7.5V13.5H5.5C4.7,13.5 4,12.8 4,12V11.5C4,10.7 4.7,10 5.5,10M12,5C15.5,5 18.5,6.5 20.2,9H16.5C16.5,6.8 14.5,5 12,5M12,17.5C14.5,17.5 16.5,15.7 16.5,13.5H20.2C18.5,16 15.5,17.5 12,17.5M7.5,9H3.8C5.5,6.5 8.5,5 12,5C9.5,5 7.5,6.8 7.5,9M7.5,13.5C7.5,15.7 9.5,17.5 12,17.5C8.5,17.5 5.5,16 3.8,13.5H7.5Z" /></svg></div><span class="app-label">èŠå¤©</span></div>
                <div class="app-item" onclick="openWorldbookApp()"><div class="app-icon" id="icon_world"><svg class="svg-icon" viewBox="0 0 24 24"><path d="M19 2L14 6.5V17.5L19 13V2M6.5 5C4.55 5 2.45 5.4 1 6.5V21.16C1 21.41 1.25 21.66 1.5 21.66C1.6 21.66 1.65 21.59 1.75 21.59C3.1 20.94 5.05 20.5 6.5 20.5C8.45 20.5 10.55 20.9 12 22C13.35 20.9 15.8 20.5 17.5 20.5C19.15 20.5 20.85 20.81 22.25 21.56C22.35 21.61 22.4 21.59 22.5 21.59C22.75 21.59 23 21.34 23 21.09V6.5C22.4 6.05 21.75 5.75 21 5.5V19C19.9 18.65 18.7 18.5 17.5 18.5C15.8 18.5 13.35 18.9 12 20V6.5C10.55 5.4 8.45 5 6.5 5Z" /></svg></div><span class="app-label">ä¸–ç•Œä¹¦</span></div>
                <div class="app-item" onclick="openInteractSelector()"><div class="app-icon" id="icon_interact"><svg class="svg-icon" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z" /></svg></div><span class="app-label">äº’åŠ¨</span></div>
                <div class="app-item" onclick="openSettingsApp()"><div class="app-icon" id="icon_appearance"><svg class="svg-icon" viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.35 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.35 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.04 4.95,18.95L7.44,17.95C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.95L19.05,18.95C19.27,19.04 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" /></svg></div><span class="app-label">å¤–è§‚</span></div>
            </div>
        </div>
        
        <div class="dock">
            <div class="dock-app" onclick="openApiApp()"><div class="dock-box" id="icon_api"><svg class="svg-icon" viewBox="0 0 24 24"><path d="M12.89,3L14.85,3.4L11.11,21L9.15,20.6L12.89,3M19.59,12L16,8.41V5.58L22.42,12L16,18.41V15.58L19.59,12M1.58,12L8,5.58V8.41L4.41,12L8,15.58V18.41L1.58,12Z" /></svg></div><span class="app-label">API</span></div>
            <div class="dock-app"><div class="dock-box" style="opacity:0.6"><svg class="svg-icon" style="opacity:0.3" viewBox="0 0 24 24"><path d="M19,19H5V5H19M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M13.96,12.29L11.21,15.83L9.25,13.47L6.5,17H17.5L13.96,12.29Z" /></svg></div><span class="app-label">å ä½</span></div>
            <div class="dock-app"><div class="dock-box" style="opacity:0.6"><svg class="svg-icon" style="opacity:0.3" viewBox="0 0 24 24"><path d="M19,19H5V5H19M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M13.96,12.29L11.21,15.83L9.25,13.47L6.5,17H17.5L13.96,12.29Z" /></svg></div><span class="app-label">å ä½</span></div>
            <div class="dock-app"><div class="dock-box" style="opacity:0.6"><svg class="svg-icon" style="opacity:0.3" viewBox="0 0 24 24"><path d="M19,19H5V5H19M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M13.96,12.29L11.21,15.83L9.25,13.47L6.5,17H17.5L13.96,12.29Z" /></svg></div><span class="app-label">å ä½</span></div>
        </div>
    </div>

    <!-- ğŸ¨ å¤–è§‚è®¾ç½® -->
    <div class="fullscreen-app" id="settingsApp">
        <div class="app-header">
            <div class="header-back" onclick="closeSettingsApp()">è¿”å›</div>
            <div class="header-title">å¤–è§‚è®¾ç½®</div>
        </div>
        <div class="settings-content">
            <div class="group-title">APP å›¾æ ‡å®šåˆ¶</div>
            <div class="settings-group">
                <div class="list-item"><div class="list-label"><div class="icon-preview" id="preview_chat"></div>èŠå¤©APP</div><button class="btn-upload" onclick="trigger('iconInput_chat')">æ¢å›¾</button><input type="file" id="iconInput_chat" accept="image/*" onchange="compressAndSave(this, 'icon_chat', 'save_icon_chat', 'preview_chat', 'image/png')"></div>
                <div class="list-item"><div class="list-label"><div class="icon-preview" id="preview_world"></div>ä¸–ç•Œä¹¦APP</div><button class="btn-upload" onclick="trigger('iconInput_world')">æ¢å›¾</button><input type="file" id="iconInput_world" accept="image/*" onchange="compressAndSave(this, 'icon_world', 'save_icon_world', 'preview_world', 'image/png')"></div>
                <div class="list-item"><div class="list-label"><div class="icon-preview" id="preview_interact"></div>äº’åŠ¨APP</div><button class="btn-upload" onclick="trigger('iconInput_interact')">æ¢å›¾</button><input type="file" id="iconInput_interact" accept="image/*" onchange="compressAndSave(this, 'icon_interact', 'save_icon_interact', 'preview_interact', 'image/png')"></div>
                <div class="list-item"><div class="list-label"><div class="icon-preview" id="preview_appearance"></div>å¤–è§‚è®¾ç½®</div><button class="btn-upload" onclick="trigger('iconInput_appearance')">æ¢å›¾</button><input type="file" id="iconInput_appearance" accept="image/*" onchange="compressAndSave(this, 'icon_appearance', 'save_icon_appearance', 'preview_appearance', 'image/png')"></div>
                <div class="list-item"><div class="list-label"><div class="icon-preview" id="preview_api"></div>APIè®¾ç½®</div><button class="btn-upload" onclick="trigger('iconInput_api')">æ¢å›¾</button><input type="file" id="iconInput_api" accept="image/*" onchange="compressAndSave(this, 'icon_api', 'save_icon_api', 'preview_api', 'image/png')"></div>
            </div>
            <div class="group-title">å…¨å±€å­—ä½“</div>
            <div class="settings-group"><div class="list-item"><input type="text" id="fontUrlInput" class="text-input" placeholder="è¾“å…¥å­—ä½“ URL"><button class="primary-btn" onclick="applyFont()">åº”ç”¨</button></div></div>
            <div class="group-title">æ¡Œé¢å£çº¸</div>
            <div class="settings-group"><div class="list-item"><button class="btn-upload" onclick="trigger('wallpaperInput')">æ›´æ¢å£çº¸</button><input type="file" id="wallpaperInput" accept="image/*" onchange="compressAndSave(this, null, 'save_wallpaper')"></div></div>
            <div style="text-align:center; padding-bottom:40px;"><button onclick="forceClearData()" style="color:red; background:none; border:none; font-size:14px;">é‡ç½®æ‰€æœ‰æ•°æ®</button></div>
        </div>
    </div>

    <!-- ğŸ¤– API è®¾ç½® -->
    <div class="fullscreen-app" id="apiSettingsApp">
        <div class="app-header"><div class="header-back" onclick="closeApiApp()">è¿”å›</div><div class="header-title">AI è¿æ¥è®¾ç½®</div></div>
        <div class="settings-content">
            <div class="group-title">æœåŠ¡å•†è®¾ç½®</div>
            <div class="settings-group">
                <div class="list-item"><input type="text" id="api_url" class="text-input" placeholder="Base URL"></div>
                <div class="list-item"><input type="password" id="api_key" class="text-input" placeholder="API Key"></div>
            </div>
            <div class="group-title">æ¨¡å‹é…ç½®</div>
            <div class="settings-group">
                <div class="list-item"><input type="text" id="api_model" class="text-input" placeholder="Model ID"></div>
                <div class="list-item" onclick="fetchModels()" style="cursor: pointer;"><span style="color: var(--primary-color);">â†» è·å–æ¨¡å‹åˆ—è¡¨</span><span style="font-size: 12px; color: #aaa;" id="fetch_status"></span></div>
                <div class="list-item" id="model_selector_row" style="display:none;"><select id="model_select" class="text-input" onchange="document.getElementById('api_model').value = this.value" style="width:100%;"></select></div>
            </div>
            <div class="settings-group">
                <div class="btn-action-row"><button class="btn-mini btn-export" onclick="exportData()">ğŸ“¤ å¯¼å‡º</button><button class="btn-mini btn-import" onclick="document.getElementById('importInput').click()">ğŸ“¥ å¯¼å…¥</button><input type="file" id="importInput" style="display:none" accept=".json" onchange="importData(this)"></div>
                <div class="list-item" onclick="saveApiSettingsUI()" style="cursor: pointer; justify-content: center;"><span style="color: var(--primary-color); font-weight: bold;">ğŸ’¾ ä¿å­˜è®¾ç½®</span></div>
                <div class="list-item" onclick="testConnection()" style="cursor: pointer; justify-content: center; border-top: 1px solid #f0f0f0;"><span style="color: #888; font-size: 14px;">ğŸ“¡ æµ‹è¯•è¿æ¥</span></div>
                <div id="test_result" style="font-size: 12px; color: #888; text-align: center; padding:5px;"></div>
            </div>
        </div>
    </div>

    <!-- ğŸ’¬ èŠå¤©åˆ—è¡¨ -->
    <div class="fullscreen-app" id="chatListApp">
        <div class="app-header"><div class="header-back" onclick="closeChatListApp()">è¿”å›</div><div class="header-title">æ¶ˆæ¯</div><div class="header-right" onclick="handleAddButton()">â•</div></div>
        <div class="chat-list-container" id="chatListContainer"><div style="padding:40px; text-align:center; color:#ccc;">åŠ è½½ä¸­...</div></div>
        <div class="friend-list-container" id="friendListContainer" style="display:none;"></div>
        <div class="bottom-nav">
            <div class="nav-tab active" id="tab-msg" onclick="switchTab('msg')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H6L4,18V4H20"/></svg>æ¶ˆæ¯</div>
            <div class="nav-tab" id="tab-friend" onclick="switchTab('friend')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg>å¥½å‹</div>
        </div>
    </div>

    <!-- ğŸ†” èµ„æ–™å¡ -->
    <div class="fullscreen-app" id="profileApp">
        <div class="profile-container">
            <div class="profile-cover" id="p_cover" onclick="trigger('p_cover_input')"><img src="" id="p_cover_img"><div class="profile-back" onclick="closeProfile()">â€¹</div></div>
            <div class="profile-card">
                <div class="profile-avatar-wrap" onclick="trigger('p_avatar_input')"><img src="" class="profile-avatar" id="p_avatar_img"></div>
                <div class="profile-info">
                    <div class="profile-name-row"><div class="profile-name" contenteditable="true" id="p_name">Name</div><div class="profile-status" id="p_status">åœ¨çº¿</div></div>
                    <div class="tag-row"><div class="info-tag editable" contenteditable="true" id="p_gender">â™€</div><div class="info-tag editable" contenteditable="true" id="p_age">18å²</div><div class="info-tag editable" contenteditable="true" id="p_birth">1æœˆ1æ—¥</div><div class="info-tag editable" contenteditable="true" id="p_job">é­”æ³•å°‘å¥³</div></div>
                    <div class="profile-signature" contenteditable="true" id="p_sign">ç­¾å...</div>
                    <div class="section-title">ç»‘å®šä¸–ç•Œä¹¦ (ç‚¹å‡»ä¿®æ”¹)</div>
                    <div class="persona-box" onclick="openWorldbookSelectModal()"><span style="color:#666;font-size:12px;">å·²ç»‘å®šçš„ä¸–ç•Œä¹¦å°†åœ¨æ­¤æ˜¾ç¤º...</span><div id="p_wb_tags" class="wb-tags-display"></div></div>
                    <div class="section-title">AI äººè®¾ (Prompt)</div>
                    <div class="persona-box" contenteditable="true" id="p_ai_persona">åœ¨æ­¤è¾“å…¥ AI çš„è¯¦ç»†è®¾å®š...</div>
                    <div class="section-title">æˆ‘çš„é©¬ç”²</div>
                    <div class="user-persona-section"><div class="user-persona-avatar" onclick="trigger('p_user_avatar_input')"><img src="" id="p_user_avatar_img"></div><div class="user-persona-text" contenteditable="true" id="p_user_persona">åœ¨æ­¤è¾“å…¥ä½ å¯¹è¿™ä¸ªè§’è‰²çš„ç‰¹å®šäººè®¾...</div></div>
                    <div class="profile-actions"><button class="action-btn btn-save" onclick="saveProfile()">ä¿å­˜ä¿¡æ¯</button><button class="action-btn btn-chat" onclick="goToChat()">å‘æ¶ˆæ¯</button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ—¨ï¸ èŠå¤©çª—å£ -->
    <div class="fullscreen-app" id="chatWindowApp">
        <div class="app-header">
            <div class="header-back" onclick="closeChatWindow()">è¿”å›</div>
            <div class="header-title"><span id="chatTitleName">Name</span><span id="chatTitleStatus" class="header-status">åœ¨çº¿</span></div>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="selection-bar"><span style="color:#666;" onclick="exitSelectionMode()">å–æ¶ˆ</span><span class="btn-delete-msgs" onclick="deleteSelectedMessages()">åˆ é™¤ (<span id="selectCount">0</span>)</span></div>
        <div class="chat-footer-wrapper">
            <div class="chat-toolbar">
                <div class="tool-btn" onclick="openStickerPanel()">ğŸ˜Š</div><div class="tool-btn" onclick="trigger('chatImgInput')">ğŸ–¼ï¸</div><div class="tool-btn" onclick="sendFakeImage()">ğŸƒ</div><div class="tool-btn" onclick="sendFakeVoice()">ğŸ¤</div>
            </div>
            <div class="chat-input-bar"><textarea class="chat-input" id="chatInput" rows="1" placeholder="å‘æ¶ˆæ¯..." onkeydown="handleEnter(event)"></textarea><div class="send-group"><div class="btn-ai" onclick="triggerAi()">âœ¨</div><div class="btn-send" onclick="sendUserMessage()">â¤</div></div></div>
        </div>
    </div>

    <input type="file" id="coverInput" accept="image/*" onchange="compressAndSave(this, 'coverImg', 'save_cover')">
    <input type="file" id="bodyInput" accept="image/*" onchange="compressAndSave(this, 'bodyBgImg', 'save_body')">
    <input type="file" id="avatarInput" accept="image/*" onchange="compressAndSave(this, 'avatarImg', 'save_avatar')">
    <input type="file" id="squareInput" accept="image/*" onchange="compressAndSave(this, 'squareImg', 'save_square')">
    <input type="file" id="chatImgInput" accept="image/*" onchange="handleRealImage(this)">
    <input type="file" id="stickerInput" accept="image/*" onchange="saveNewSticker(this)">
    <input type="file" id="p_cover_input" accept="image/*" onchange="loadProfileImg(this, 'p_cover_img')">
    <input type="file" id="p_avatar_input" accept="image/*" onchange="loadProfileImg(this, 'p_avatar_img')">
    <input type="file" id="p_user_avatar_input" accept="image/*" onchange="loadProfileImg(this, 'p_user_avatar_img')">

    <script>
        const Modal = {
            overlay: document.getElementById('custom-modal-overlay'), title: document.getElementById('modal-title'), desc: document.getElementById('modal-desc'), input: document.getElementById('modal-input'), stickerArea: document.getElementById('sticker-area'), btnConfirm: document.getElementById('btn-confirm'), btnCancel: document.getElementById('btn-cancel'), resolve: null,
            show(type, title, desc = '', placeholder = '') { return new Promise((resolve) => { this.resolve = resolve; this.title.innerText = title; this.desc.innerText = desc; this.desc.style.display = desc ? 'block' : 'none'; this.overlay.classList.add('active'); this.btnConfirm.className = 'modal-btn btn-confirm'; this.btnConfirm.innerText = 'ç¡®å®š'; this.btnCancel.style.display = 'block'; this.stickerArea.style.display = 'none'; this.input.style.display = 'none'; if (type === 'prompt') { this.input.style.display = 'block'; this.input.value = ''; this.input.placeholder = placeholder; this.input.focus(); } else if (type === 'sticker') { this.stickerArea.style.display = 'grid'; this.btnConfirm.innerText = 'ä¸Šä¼ æ–°è¡¨æƒ…'; this.renderStickers(); } else if (type === 'confirm-danger') { this.btnConfirm.className = 'modal-btn btn-danger'; this.btnConfirm.innerText = 'åˆ é™¤'; } else if (type === 'alert') { this.btnCancel.style.display = 'none'; } this.btnConfirm.onclick = () => { if(type === 'sticker') document.getElementById('stickerInput').click(); else { const val = type === 'prompt' ? this.input.value : true; this.close(val); } }; this.btnCancel.onclick = () => this.close(false); }); },
            close(val) { this.overlay.classList.remove('active'); if (this.resolve) this.resolve(val); this.resolve = null; },
            renderStickers() { const stickers = JSON.parse(localStorage.getItem('saved_stickers') || '[]'); this.stickerArea.innerHTML = ''; const clearBtn = document.createElement('div'); clearBtn.innerHTML = 'ğŸ—‘ï¸ æ¸…ç©º'; clearBtn.style.cssText = "grid-column:1/-1;text-align:center;color:red;padding:10px;cursor:pointer;font-size:12px;"; clearBtn.onclick = async () => { if(await Modal.show('confirm-danger', 'æ¸…ç©ºæ‰€æœ‰è¡¨æƒ…?')) { localStorage.removeItem('saved_stickers'); this.renderStickers(); } }; this.stickerArea.appendChild(clearBtn); stickers.forEach((item, index) => { const div = document.createElement('div'); div.className = 'sticker-item'; div.innerHTML = `<img src="${item.url}">`; div.onclick = () => this.close(item); let timer; div.addEventListener('touchstart', () => { timer = setTimeout(async () => { if(await Modal.show('confirm-danger', 'åˆ é™¤æ­¤è¡¨æƒ…?')) { stickers.splice(index, 1); localStorage.setItem('saved_stickers', JSON.stringify(stickers)); this.renderStickers(); } }, 600); }); div.addEventListener('touchend', () => clearTimeout(timer)); this.stickerArea.appendChild(div); }); }
        };
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2000); }
        window.onerror = function(msg) { alert("âŒ é”™è¯¯: " + msg); return false; };

        let activeChatId=null, activeChatName="", activeChatAvatar="", currentProfileId=null, isSelectionMode=false, selectedIndices=new Set(), longPressTimer, interactId=null, vnQueue=[], isVnInputMode=false, vnState={outfit:'default',face:'normal',bgName:''}, lastAutoScheduleIndex=-1, tempSpriteData=null;

        window.onload = function() {
            try { loadText('txt_name'); loadText('txt_bio1'); loadText('txt_bio2'); loadText('txt_loc'); loadSavedImg('save_cover','coverImg',true); loadSavedImg('save_body','bodyBgImg',true); loadSavedImg('save_avatar','avatarImg',false); loadSavedImg('save_square','squareImg',false); setupTextSaver('txt_name'); setupTextSaver('txt_bio1'); setupTextSaver('txt_bio2'); setupTextSaver('txt_loc'); loadCustomFont(); loadWallpaper(); loadApiSettings(); 
            const apps=[{key:'save_icon_chat',id:'icon_chat',prev:'preview_chat'},{key:'save_icon_world',id:'icon_world',prev:'preview_world'},{key:'save_icon_interact',id:'icon_interact',prev:'preview_interact'},{key:'save_icon_appearance',id:'icon_appearance',prev:'preview_appearance'},{key:'save_icon_api',id:'icon_api',prev:'preview_api'}]; apps.forEach(app => loadSavedIcon(app.key, app.id, app.prev)); initMockChats(); } catch (e) { console.error(e); }
        };

        /* Worldbook */
        function openWorldbookApp() { document.getElementById('worldbookApp').classList.add('active'); document.getElementById('desktop').classList.add('pushed'); renderWorldbookList(); }
        function closeWorldbookApp() { document.getElementById('worldbookApp').classList.remove('active'); document.getElementById('desktop').classList.remove('pushed'); }
        async function createWorldbook() { const title = await Modal.show('prompt', 'æ–°å»ºä¸–ç•Œä¹¦', '', 'æ ‡é¢˜'); if(!title) return; const books = JSON.parse(localStorage.getItem('worldbooks') || '[]'); books.push({ id: 'wb_'+Date.now(), title: title, mode: 'always', entries: [] }); localStorage.setItem('worldbooks', JSON.stringify(books)); renderWorldbookList(); }
        function renderWorldbookList() { const books = JSON.parse(localStorage.getItem('worldbooks') || '[]'); const container = document.getElementById('worldbook-list'); container.innerHTML = ''; if(books.length === 0) { container.innerHTML = '<div style="text-align:center;padding:20px;color:#ccc;">æš‚æ— ä¸–ç•Œä¹¦</div>'; return; } books.forEach((book, index) => { const card = document.createElement('div'); card.className = 'wb-card'; card.id = 'wb-card-' + book.id; const isAlways = (book.mode !== 'keyword'); const modeText = isAlways ? 'âš¡ å§‹ç»ˆç”Ÿæ•ˆ' : 'ğŸ” å…³é”®è¯æ£€æµ‹'; const modeClass = isAlways ? 'always' : 'keyword'; const keyPlaceholder = isAlways ? 'å¤‡æ³¨/æ ‡é¢˜ (å¯é€‰)' : 'å…³é”®è¯ (å¿…å¡«)'; let entriesHtml = ''; book.entries.forEach((entry, eIdx) => { entriesHtml += `<div class="wb-entry-row"><input type="text" class="wb-entry-key" value="${entry.key}" placeholder="${keyPlaceholder}" onchange="updateEntry('${book.id}', ${eIdx}, 'key', this.value)"><textarea class="wb-entry-val" placeholder="è¯¦ç»†è®¾å®š..." onchange="updateEntry('${book.id}', ${eIdx}, 'content', this.value)">${entry.content}</textarea><button class="btn-icon btn-del" onclick="deleteEntry('${book.id}', ${eIdx})">Ã—</button></div>`; }); card.innerHTML = `<div class="wb-header"><div class="wb-title-row"><input type="text" class="wb-title-input" value="${book.title}" onchange="updateWorldbookTitle('${book.id}', this.value)"><div class="wb-mode-btn ${modeClass}" onclick="toggleWorldbookMode('${book.id}')">${modeText}</div><button class="btn-icon btn-del" onclick="deleteWorldbook('${book.id}')">ğŸ—‘ï¸</button></div></div><div class="wb-toggle" onclick="toggleWorldbookCard('${book.id}')">â–¼</div><div class="wb-entries">${entriesHtml}<button class="btn-mini btn-add" onclick="addEntry('${book.id}')">â• æ·»åŠ æ¡ç›®</button></div>`; container.appendChild(card); }); }
        function toggleWorldbookMode(id) { const books = JSON.parse(localStorage.getItem('worldbooks') || '[]'); const b = books.find(x => x.id === id); if(b) { b.mode = (b.mode === 'keyword') ? 'always' : 'keyword'; localStorage.setItem('worldbooks', JSON.stringify(books)); renderWorldbookList(); } }
        function toggleWorldbookCard(id) { document.getElementById('wb-card-'+id).classList.toggle('open'); }
        function updateWorldbookTitle(id, val) { const books = JSON.parse(localStorage.getItem('worldbooks') || '[]'); const b = books.find(x => x.id === id); if(b) { b.title = val; localStorage.setItem('worldbooks', JSON.stringify(books)); } }
        function deleteWorldbook(id) { Modal.show('confirm-danger', 'åˆ é™¤æ­¤ä¸–ç•Œä¹¦?').then(r => { if(r) { let books = JSON.parse(localStorage.getItem('worldbooks') || '[]'); books = books.filter(x => x.id !== id); localStorage.setItem('worldbooks', JSON.stringify(books)); renderWorldbookList(); } }); }
        function addEntry(id) { const books = JSON.parse(localStorage.getItem('worldbooks') || '[]'); const b = books.find(x => x.id === id); if(b) { b.entries.push({ key: '', content: '' }); localStorage.setItem('worldbooks', JSON.stringify(books)); renderWorldbookList(); setTimeout(()=>toggleWorldbookCard(id), 50); } }
        function updateEntry(bookId, entryIdx, field, val) { const books = JSON.parse(localStorage.getItem('worldbooks') || '[]'); const b = books.find(x => x.id === bookId); if(b && b.entries[entryIdx]) { b.entries[entryIdx][field] = val; localStorage.setItem('worldbooks', JSON.stringify(books)); } }
        function deleteEntry(bookId, entryIdx) { const books = JSON.parse(localStorage.getItem('worldbooks') || '[]'); const b = books.find(x => x.id === bookId); if(b) { b.entries.splice(entryIdx, 1); localStorage.setItem('worldbooks', JSON.stringify(books)); renderWorldbookList(); setTimeout(()=>toggleWorldbookCard(bookId), 50); } }
        function openWorldbookSelectModal() { if(!currentProfileId) return; const books = JSON.parse(localStorage.getItem('worldbooks') || '[]'); const profile = JSON.parse(localStorage.getItem('chat_profile_'+currentProfileId) || '{}'); const selectedIds = profile.worldbook_ids || []; const list = document.getElementById('wb-select-list'); list.innerHTML = ''; if(books.length === 0) { list.innerHTML = '<div style="color:#999;text-align:center;">æš‚æ— ä¸–ç•Œä¹¦ï¼Œè¯·å…ˆåˆ›å»º</div>'; } books.forEach(b => { const div = document.createElement('div'); div.className = 'checkbox-item'; div.innerHTML = `<input type="checkbox" value="${b.id}" ${selectedIds.includes(b.id)?'checked':''}><span>${b.title} (${b.entries.length}æ¡ç›®)</span>`; list.appendChild(div); }); document.getElementById('worldbook-select-overlay').classList.add('active'); }
        function saveWorldbookSelection() { if(!currentProfileId) return; const checkboxes = document.querySelectorAll('#wb-select-list input[type="checkbox"]:checked'); const selectedIds = Array.from(checkboxes).map(c => c.value); const profile = JSON.parse(localStorage.getItem('chat_profile_'+currentProfileId) || '{}'); profile.worldbook_ids = selectedIds; localStorage.setItem('chat_profile_'+currentProfileId, JSON.stringify(profile)); document.getElementById('worldbook-select-overlay').classList.remove('active'); renderWorldbookTags(selectedIds); showToast("ç»‘å®šå·²æ›´æ–°"); }
        function renderWorldbookTags(ids) { const container = document.getElementById('p_wb_tags'); container.innerHTML = ''; if(!ids || ids.length === 0) return; const books = JSON.parse(localStorage.getItem('worldbooks') || '[]'); ids.forEach(id => { const b = books.find(x => x.id === id); if(b) { const tag = document.createElement('span'); tag.className = 'wb-tag'; tag.innerText = b.title; container.appendChild(tag); } }); }
        function getWorldbookPrompt(profileId, historyText) { const profile = JSON.parse(localStorage.getItem('chat_profile_'+profileId) || '{}'); const wbIds = profile.worldbook_ids || []; if(wbIds.length === 0) return ""; const books = JSON.parse(localStorage.getItem('worldbooks') || '[]'); let matchedEntries = []; books.forEach(book => { if(wbIds.includes(book.id)) { if (book.mode === 'keyword') { book.entries.forEach(entry => { if(entry.key && entry.content && historyText.includes(entry.key)) { matchedEntries.push(`[${book.title} - ${entry.key}]: ${entry.content}`); } }); } else { book.entries.forEach(entry => { if(entry.content) { const label = entry.key ? `[${entry.key}] ` : ''; matchedEntries.push(`${label}${entry.content}`); } }); } } }); if(matchedEntries.length === 0) return ""; return "\n[World Info / Lore]:\n" + matchedEntries.join("\n") + "\n"; }

        /* Interact Mode */
        function openInteractSelector() { const list = JSON.parse(localStorage.getItem('chat_list_data') || '[]'); const container = document.getElementById('interactList'); container.innerHTML = ''; if(list.length === 0) { container.innerHTML = '<div style="padding:20px;text-align:center;">æ²¡æœ‰å¥½å‹</div>'; } else { list.forEach(c => { const item = document.createElement('div'); item.className = 'selector-item'; item.innerHTML = `<img class="selector-avatar" src="${c.avatar}"><span class="selector-name">${c.name}</span>`; item.onclick = () => startInteraction(c.id, c.name); container.appendChild(item); }); } document.getElementById('interactSelector').classList.add('active'); }
        function closeInteractSelector() { document.getElementById('interactSelector').classList.remove('active'); }
        function startInteraction(id, name) { interactId = id; activeChatId = id; closeInteractSelector(); document.getElementById('interactApp').classList.add('active'); const assetsKey = 'chat_vn_assets_' + id; if(!localStorage.getItem(assetsKey)) localStorage.setItem(assetsKey, JSON.stringify({ backgrounds: [], sprites: [] })); const data = JSON.parse(localStorage.getItem(assetsKey)); if(data.sprites.length > 0) { vnState.outfit = data.sprites[0].outfit || 'default'; vnState.face = 'normal'; } else { vnState.outfit = 'default'; vnState.face = 'normal'; } const profile = JSON.parse(localStorage.getItem('chat_profile_'+interactId) || '{}'); const bgItem = data.backgrounds.find(b => b.url === profile.interact_bg); vnState.bgName = bgItem ? bgItem.name : ''; updateInteractDisplay(); document.getElementById('vnName').innerText = name; vnQueue = ["ç‚¹å‡»å±å¹•æ¨è¿›å‰§æƒ…...", "å³ä¸Šè§’å¯åˆ‡æ¢è¾“å…¥æ¨¡å¼ã€‚"]; nextVnLine(); startScheduleTimer(); }
        function updateInteractDisplay() { const assetsKey = 'chat_vn_assets_' + interactId; const data = JSON.parse(localStorage.getItem(assetsKey) || '{"backgrounds":[], "sprites":[]}'); const profile = JSON.parse(localStorage.getItem('chat_profile_'+interactId) || '{}'); const bgEl = document.getElementById('vnBg'); if(bgEl) bgEl.src = profile.interact_bg || 'https://via.placeholder.com/400x800/222/fff?text=No+Background'; let targetSprite = data.sprites.find(s => s.outfit === vnState.outfit && s.face === vnState.face) || data.sprites.find(s => s.outfit === vnState.outfit && s.face === 'normal') || data.sprites.find(s => s.outfit === vnState.outfit) || data.sprites[0]; const tachieEl = document.getElementById('vnTachie'); if(tachieEl) tachieEl.src = targetSprite ? targetSprite.url : 'https://via.placeholder.com/300x600/transparent/fff?text=No+Sprite'; }
        function closeInteractApp() { document.getElementById('interactApp').classList.remove('active'); activeChatId = null; stopScheduleTimer(); }
        function toggleDialogue() { document.getElementById('vnTextbox').classList.toggle('hidden'); }
        document.getElementById('vnTextbox').onclick = function(e) { if(isVnInputMode) return; nextVnLine(); };
        function toggleVnInput(e) { e.stopPropagation(); isVnInputMode = !isVnInputMode; const wrap = document.getElementById('vnInputWrapper'); const toggle = document.getElementById('vnToggleBtn'); if(isVnInputMode) { wrap.classList.add('active'); toggle.innerText = 'âŒ'; document.getElementById('vnTextContent').style.display = 'none'; document.getElementById('vnInput').focus(); } else { wrap.classList.remove('active'); toggle.innerText = 'âŒ¨ï¸'; document.getElementById('vnTextContent').style.display = 'block'; } }
        function sendVnUserMessage(e) { if(e) e.stopPropagation(); const input = document.getElementById('vnInput'); const text = input.value.trim(); if(!text) return; const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); const msg = { role: 'user', type: 'text', content: text, time: time }; saveChatMessage(interactId, msg); input.value = ''; document.getElementById('vnName').innerText = 'æˆ‘'; document.getElementById('vnTextContent').innerText = text; toggleVnInput(new Event('mock')); }
        function nextVnLine() { if(vnQueue.length > 0) { let line = vnQueue.shift(); const faceMatch = line.match(/\(face:\s*(\w+)\)/i); if(faceMatch) { vnState.face = faceMatch[1].toLowerCase(); line = line.replace(faceMatch[0], '').trim(); updateInteractDisplay(); } if (!line) { if (vnQueue.length > 0) nextVnLine(); return; } document.getElementById('vnTextContent').innerText = line; } else { showToast("å¾…æœºä¸­..."); } }
        function showVnHistory() { const panel = document.getElementById('vnHistoryPanel'); const content = document.getElementById('vnHistoryContent'); content.innerHTML = ''; const list = getChatHistory(interactId); list.forEach(msg => { const div = document.createElement('div'); div.className = 'vn-hist-item'; div.innerHTML = `<div class="vn-hist-name">${msg.role==='user'?'æˆ‘':'TA'}</div><div class="vn-hist-content">${msg.content}</div>`; content.appendChild(div); }); panel.classList.add('active'); }
        
        function openVNSettings() { document.getElementById('interactSettingsApp').classList.add('active'); renderAssetList('bg'); renderAssetList('sprite'); renderScheduleList(); }
        function closeVNSettings() { document.getElementById('interactSettingsApp').classList.remove('active'); }
        function renderAssetList(type) { const assetsKey = 'chat_vn_assets_' + interactId; const data = JSON.parse(localStorage.getItem(assetsKey) || '{"backgrounds":[], "sprites":[]}'); const list = type === 'bg' ? data.backgrounds : data.sprites; const container = document.getElementById(type === 'bg' ? 'vnBgGrid' : 'vnSpriteGrid'); container.innerHTML = ''; if(list.length === 0) { container.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;">æ— èµ„æº</div>'; return; } const currentProfile = JSON.parse(localStorage.getItem('chat_profile_'+interactId) || '{}'); list.forEach((item, index) => { const div = document.createElement('div'); div.className = 'asset-item'; let displayName = item.name; if(type === 'sprite' && item.outfit) displayName = `${item.outfit} / ${item.face}`; div.innerHTML = `<img src="${item.url}"><div class="asset-name">${displayName}</div>`; if(type === 'bg') { if(item.url === currentProfile.interact_bg) div.classList.add('active'); div.onclick = () => { const profile = JSON.parse(localStorage.getItem('chat_profile_'+interactId) || '{}'); profile.interact_bg = item.url; localStorage.setItem('chat_profile_'+interactId, JSON.stringify(profile)); vnState.bgName = item.name; showToast(`èƒŒæ™¯å·²åˆ‡æ¢: ${item.name}`); renderAssetList('bg'); if(activeChatId === interactId) updateInteractDisplay(); }; } else { div.onclick = () => { vnState.outfit = item.outfit; vnState.face = item.face; showToast(`ç«‹ç»˜å·²åˆ‡æ¢`); if(activeChatId === interactId) updateInteractDisplay(); } } let timer; div.addEventListener('touchstart', () => { timer = setTimeout(async () => { if(await Modal.show('confirm-danger', `åˆ é™¤ ${displayName}?`)) { list.splice(index, 1); if(type==='bg') data.backgrounds = list; else data.sprites = list; localStorage.setItem(assetsKey, JSON.stringify(data)); renderAssetList(type); } }, 600); }); div.addEventListener('touchend', () => clearTimeout(timer)); container.appendChild(div); }); }
        
        /* Auto Schedule */
        let scheduleTimer = null;
        function renderScheduleList() { const listKey = 'chat_vn_schedule_' + interactId; let schedule = JSON.parse(localStorage.getItem(listKey) || '[]').sort((a, b) => a.time.localeCompare(b.time)); const container = document.getElementById('scheduleList'); container.innerHTML = ''; if (schedule.length === 0) { container.innerHTML = '<div style="color:#999; font-size:12px; text-align:center; padding:5px;">æš‚æ— ä½œæ¯</div>'; return; } schedule.forEach((item, index) => { const typeMap = { 'everyday': 'æ¯å¤©', 'weekday': 'å·¥ä½œæ—¥', 'weekend': 'å‘¨æœ«' }; const div = document.createElement('div'); div.style.cssText = "display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #eee; font-size:13px;"; div.innerHTML = `<div style="display:flex; flex-direction:column;"><div><span style="font-weight:bold; color:var(--primary-color);">${item.time}</span> <span style="color:#999;font-size:10px;border:1px solid #ddd;padding:1px 4px;border-radius:4px;">${typeMap[item.type]||'æ¯å¤©'}</span></div><div style="color:#555;">ğŸ‘• ${item.outfit}  ğŸ–¼ï¸ ${item.scene || '-'}</div></div><div style="color:red; cursor:pointer; padding:5px;" onclick="deleteScheduleItem(${index})">Ã—</div>`; container.appendChild(div); }); }
        function addScheduleItem() { const type = document.getElementById('schedType').value; const time = document.getElementById('schedTime').value; const outfit = document.getElementById('schedOutfit').value.trim(); const scene = document.getElementById('schedScene').value.trim(); if (!time || !outfit) return showToast("è¯·è‡³å°‘å¡«å†™æ—¶é—´å’Œæœè£…ID"); const listKey = 'chat_vn_schedule_' + interactId; let schedule = JSON.parse(localStorage.getItem(listKey) || '[]'); schedule.push({ type, time, outfit, scene }); localStorage.setItem(listKey, JSON.stringify(schedule)); renderScheduleList(); checkScheduleState(); showToast("ä½œæ¯å·²æ·»åŠ "); }
        function deleteScheduleItem(index) { const listKey = 'chat_vn_schedule_' + interactId; let schedule = JSON.parse(localStorage.getItem(listKey) || '[]').sort((a, b) => a.time.localeCompare(b.time)); schedule.splice(index, 1); localStorage.setItem(listKey, JSON.stringify(schedule)); renderScheduleList(); }
        function checkScheduleState() { if (!interactId) return; const listKey = 'chat_vn_schedule_' + interactId; let schedule = JSON.parse(localStorage.getItem(listKey) || '[]'); if (schedule.length === 0) return; const now = new Date(); const day = now.getDay(); const isWeekend = (day === 0 || day === 6); const currentTimeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0'); const validItems = schedule.filter(item => { if (item.type === 'everyday') return true; if (item.type === 'weekend' && isWeekend) return true; if (item.type === 'weekday' && !isWeekend) return true; return false; }).sort((a, b) => a.time.localeCompare(b.time)); if (validItems.length === 0) return; let activeItem = null; for (let i = validItems.length - 1; i >= 0; i--) { if (currentTimeStr >= validItems[i].time) { activeItem = validItems[i]; break; } } if (!activeItem) { activeItem = validItems[validItems.length - 1]; } const currentScheduleKey = `${activeItem.time}|${activeItem.outfit}|${activeItem.scene}|${isWeekend?'we':'wd'}`; if (lastAutoScheduleIndex !== currentScheduleKey) { console.log(`[Schedule] Switch: ${currentScheduleKey}`); if (activeItem.outfit) vnState.outfit = activeItem.outfit; if (activeItem.scene) { const assetsKey = 'chat_vn_assets_' + interactId; const data = JSON.parse(localStorage.getItem(assetsKey) || '{"backgrounds":[]}'); const bgObj = data.backgrounds.find(b => b.name === activeItem.scene); if (bgObj) { const profile = JSON.parse(localStorage.getItem('chat_profile_'+interactId) || '{}'); profile.interact_bg = bgObj.url; localStorage.setItem('chat_profile_'+interactId, JSON.stringify(profile)); vnState.bgName = activeItem.scene; } } updateInteractDisplay(); lastAutoScheduleIndex = currentScheduleKey; } }
        function startScheduleTimer() { if (scheduleTimer) clearInterval(scheduleTimer); lastAutoScheduleIndex = -1; checkScheduleState(); scheduleTimer = setInterval(checkScheduleState, 60000); }
        function stopScheduleTimer() { if (scheduleTimer) clearInterval(scheduleTimer); scheduleTimer = null; }
        
        function handleSpriteUploadStart(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = async e => { const img = new Image(); img.src = e.target.result; img.onload = () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); const max = 400; let w=img.width, h=img.height; if(w>max){h*=max/w;w=max;} c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h); tempSpriteData = c.toDataURL('image/png'); document.getElementById('sprite-outfit-input').value = ''; document.getElementById('sprite-face-input').value = ''; document.getElementById('sprite-upload-overlay').classList.add('active'); } }; reader.readAsDataURL(input.files[0]); input.value=''; } }
        document.getElementById('btn-confirm-sprite').onclick = function() { const outfit = document.getElementById('sprite-outfit-input').value.trim() || 'default'; const face = document.getElementById('sprite-face-input').value.trim() || 'normal'; if(tempSpriteData) { const assetsKey = 'chat_vn_assets_' + interactId; const data = JSON.parse(localStorage.getItem(assetsKey) || '{"backgrounds":[], "sprites":[]}'); data.sprites.push({ outfit: outfit, face: face, url: tempSpriteData, name: `${outfit}_${face}` }); localStorage.setItem(assetsKey, JSON.stringify(data)); renderAssetList('sprite'); showToast("ç«‹ç»˜ä¸Šä¼ æˆåŠŸ"); } closeSpriteModal(); };
        function closeSpriteModal() { document.getElementById('sprite-upload-overlay').classList.remove('active'); tempSpriteData = null; }
        function handleVNUpload(input, type) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = async e => { const img = new Image(); img.src = e.target.result; img.onload = async () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); const max = 800; let w=img.width, h=img.height; if(w>max){h*=max/w;w=max;} c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h); const url = c.toDataURL('image/jpeg', 0.7); const name = await Modal.show('prompt', 'å‘½åèƒŒæ™¯', '', 'å¦‚: office'); if(name) { const assetsKey = 'chat_vn_assets_' + interactId; const data = JSON.parse(localStorage.getItem(assetsKey) || '{"backgrounds":[], "sprites":[]}'); data.backgrounds.push({name, url}); localStorage.setItem(assetsKey, JSON.stringify(data)); renderAssetList('bg'); showToast("ä¸Šä¼ æˆåŠŸ"); } } }; reader.readAsDataURL(input.files[0]); input.value=''; } }

        /* Standard Chat Features */
        function createNewChat() { Modal.show('prompt', 'æ–°å»ºèŠå¤©', '', 'è¾“å…¥åå­—').then(name => { if(name){ const list = JSON.parse(localStorage.getItem('chat_list_data')||'[]'); const id = 'c' + Date.now(); list.unshift({ id: id, name: name, avatar: `https://ui-avatars.com/api/?name=${name}&background=random`, lastMsg: 'æ–°ä¼šè¯', time: 'åˆšåˆš' }); localStorage.setItem('chat_list_data', JSON.stringify(list)); renderChatList(); } }); }
        function handleAddButton() { const isFriendTab = document.getElementById('friendListContainer').style.display === 'block'; if(isFriendTab) { const list = JSON.parse(localStorage.getItem('chat_list_data')||'[]'); list.push({ id: 'f'+Date.now(), name: 'æ–°æœ‹å‹', avatar: 'https://via.placeholder.com/100', lastMsg: '', time: '' }); localStorage.setItem('chat_list_data', JSON.stringify(list)); renderFriendList(); showToast("å¥½å‹å·²æ·»åŠ "); } else { createNewChat(); } }
        async function deleteChat(e, id) { if(e) { e.stopPropagation(); e.preventDefault(); } if(await Modal.show('confirm-danger', 'åˆ é™¤èŠå¤©ï¼Ÿ')) { const list = JSON.parse(localStorage.getItem('chat_list_data')||'[]'); const idx = list.findIndex(c => c.id == id); if(idx !== -1) { list[idx].hidden = true; localStorage.setItem('chat_list_data', JSON.stringify(list)); renderChatList(); showToast("å·²åˆ é™¤"); } } }
        function renderChatList() { const container = document.getElementById('chatListContainer'); let list = JSON.parse(localStorage.getItem('chat_list_data') || '[]'); const visibleList = list.filter(c => !c.hidden); if (visibleList.length === 0) { container.innerHTML = '<div style="padding:50px; text-align:center; color:#ccc;">æš‚æ— æ¶ˆæ¯</div>'; return; } let html = ''; visibleList.forEach(chat => { html += `<div class="chat-swipe-wrapper"><div class="chat-delete-action" ontouchend="deleteChat(event, '${chat.id}')" onclick="deleteChat(event, '${chat.id}')">åˆ é™¤</div><div class="chat-item" onclick="openChatWindow('${chat.id}', '${chat.name}', '${chat.avatar}')"><div class="chat-avatar"><img src="${chat.avatar}"></div><div class="chat-content"><div class="chat-top-row"><span class="chat-name">${chat.name}</span><span class="chat-time">${chat.time}</span></div><div class="chat-preview">${chat.lastMsg}</div></div></div></div>`; }); container.innerHTML = html; }
        
        /* Chat Logic */
        async function deleteSelectedMessages() { if (selectedIndices.size === 0) return; if (!await Modal.show('confirm-danger', `åˆ é™¤ ${selectedIndices.size}æ¡?`)) return; let history = getChatHistory(activeChatId); history = history.filter((_, idx) => !selectedIndices.has(Number(idx))); localStorage.setItem('chat_history_' + activeChatId, JSON.stringify(history)); updateChatListPreview(activeChatId, history.length>0?history[history.length-1].content:'', ''); exitSelectionMode(); renderChatMessages(); showToast("å·²åˆ é™¤"); }
        async function openStickerPanel() { const stickerObj = await Modal.show('sticker', 'é€‰æ‹©è¡¨æƒ…åŒ…'); if(stickerObj && stickerObj.url) sendSpecialMessage('sticker', stickerObj.url, stickerObj.desc); }
        function saveNewSticker(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.src = e.target.result; img.onload = async () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); let w=img.width, h=img.height; if(w>100){h*=100/w;w=100;} c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h); const url = c.toDataURL('image/webp', 0.5); const desc = await Modal.show('prompt', 'å«ä¹‰', ''); if(desc) { const list = JSON.parse(localStorage.getItem('saved_stickers') || '[]'); list.push({url: url, desc: desc}); localStorage.setItem('saved_stickers', JSON.stringify(list)); Modal.renderStickers(); showToast("å·²æ·»åŠ "); } } }; reader.readAsDataURL(input.files[0]); input.value=''; } }
        function handleRealImage(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.src = e.target.result; img.onload = () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); let w=img.width, h=img.height; if(w>600){h*=600/w;w=600;} c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h); sendSpecialMessage('image', c.toDataURL('image/jpeg', 0.7)); } }; reader.readAsDataURL(input.files[0]); input.value=''; } }
        async function sendFakeImage() { const desc = await Modal.show('prompt', 'å›¾ç‰‡æè¿°'); if(desc) sendSpecialMessage('fake-image', desc); }
        async function sendFakeVoice() { const text = await Modal.show('prompt', 'è¯­éŸ³å†…å®¹'); if(text) sendSpecialMessage('voice', text); }
        function triggerAi() { if(!activeChatId) return; if(getChatHistory(activeChatId).length === 0) return showToast("è¯·å…ˆå‘æ¶ˆæ¯"); callAi(null, true); }
        function sendSpecialMessage(type, content, desc='') { const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); const msg = { role: 'user', type: type, content: content, desc: desc, time: time }; saveChatMessage(activeChatId, msg); appendMessageToUI(msg, -1); setTimeout(scrollToBottom, 200); }
        function appendMessageToUI(msg, index = -1) { const container = document.getElementById('chatMessages'); const isSelf = msg.role === 'user'; if (index === -1) index = container.children.length; const div = document.createElement('div'); div.className = `msg-row ${isSelf ? 'self' : 'other'}`; div.id = `msg-${index}`; div.addEventListener('touchstart', () => { if(!isSelectionMode) longPressTimer = setTimeout(() => handleLongPress(index), 600); }); div.addEventListener('touchend', () => clearTimeout(longPressTimer)); div.addEventListener('touchmove', () => clearTimeout(longPressTimer)); div.oncontextmenu = function() { return false; }; div.addEventListener('click', () => { if(isSelectionMode) toggleSelection(index); }); let avatarUrl; if (isSelf) { const profile = JSON.parse(localStorage.getItem('chat_profile_' + activeChatId) || '{}'); avatarUrl = profile.userAvatar || document.getElementById('avatarImg').src; } else { avatarUrl = activeChatAvatar; } const contentWrapper = document.createElement('div'); contentWrapper.className = 'msg-bubble-wrapper'; const bubble = document.createElement('div'); bubble.className = 'msg-bubble'; if (msg.type === 'sticker') { bubble.innerHTML = `<img src="${msg.content}" class="msg-sticker">`; } else if (msg.type === 'image') { bubble.innerHTML = `<img src="${msg.content}" class="msg-img">`; } else if (msg.type === 'fake-image') { bubble.innerHTML = `<div class="msg-fake-img-box">ğŸ–¼ï¸ å›¾ç‰‡<br>(ç‚¹å‡»æŸ¥çœ‹)</div>`; bubble.onclick = (e) => { if(!isSelectionMode) { e.stopPropagation(); Modal.show('alert', 'å›¾ç‰‡æè¿°', msg.content); } }; } else if (msg.type === 'voice') { const len = Math.min(60, Math.ceil(msg.content.length / 2)); const voiceBox = document.createElement('div'); voiceBox.className = 'msg-voice-box'; voiceBox.innerHTML = `<span class="voice-icon">ğŸ”Š</span> ${len}"`; voiceBox.onclick = function(e) { if(isSelectionMode) return; e.stopPropagation(); if(this.classList.contains('show-text')) { this.innerHTML = `<span class="voice-icon">ğŸ”Š</span> ${len}"`; this.classList.remove('show-text'); } else { this.innerHTML = msg.content; this.classList.add('show-text'); } }; bubble.appendChild(voiceBox); } else { bubble.innerHTML = `<div class="msg-content">${msg.content}</div>`; } contentWrapper.appendChild(bubble); const avatarHtml = `<div class="avatar-container"><div class="msg-avatar"><img src="${avatarUrl}"></div><div class="msg-time">${msg.time || 'åˆšåˆš'}</div></div>`; if (!isSelf) div.insertAdjacentHTML('beforeend', avatarHtml); div.appendChild(contentWrapper); if (isSelf) div.insertAdjacentHTML('beforeend', avatarHtml); container.appendChild(div); if(index === -1) scrollToBottom(); }
        function saveChatMessage(id, msg) { const list = getChatHistory(id); if(!msg.type) msg.type = 'text'; list.push(msg); localStorage.setItem('chat_history_' + id, JSON.stringify(list)); let preview = msg.type==='text'?msg.content:'[å¤šåª’ä½“]'; updateChatListPreview(id, preview, msg.time); }
        
        async function callAi(userText, force=false) { 
            if(!force && !userText) return; 
            const s = document.getElementById('chatTitleStatus'); if(s) s.innerText="è¾“å…¥ä¸­..."; 
            const {cleanUrl, key, model} = saveApiSettingsInternal(); 
            if(!cleanUrl || !key){ appendMessageToUI({role:'assistant',type:'text',content:"âš ï¸ é…ç½®API"},-1); if(s) s.innerText="åœ¨çº¿"; return; } 
            const p = JSON.parse(localStorage.getItem('chat_profile_'+activeChatId)||'{}'); 
            const h = getChatHistory(activeChatId).slice(-10); 
            const historyText = h.map(m => m.content).join("\n") + "\n" + (userText || "");
            const wbPrompt = getWorldbookPrompt(activeChatId, historyText);
            const cm = h.map(m=>({role:m.role, content:m.content})); 
            const ms = [{role:"system", content:`Persona: ${p.aiPersona}.\n${wbPrompt}\nReply with multiple bubbles split by /n.`}, ...cm]; 
            try {
                const r = await fetch(`${cleanUrl}/chat/completions`,{method:'POST',headers:{'Authorization':`Bearer ${key}`,'Content-Type':'application/json'},body:JSON.stringify({model:model||"gpt-3.5-turbo",messages:ms})}); 
                if(r.ok){
                    const d = await r.json(); const txt = d.choices?.[0]?.message?.content || "..."; 
                    const parts = txt.split('/n'); const time = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); 
                    for(const part of parts){ 
                        if(part.trim()){ const m={role:'assistant',type:'text',content:part.trim(),time:time}; saveChatMessage(activeChatId,m); appendMessageToUI(m,-1); await new Promise(r=>setTimeout(r,800)); } 
                    } 
                } 
            } catch(e) { appendMessageToUI({role:'assistant',type:'text',content:"[é”™è¯¯]"},-1); } finally { if(s) s.innerText="åœ¨çº¿"; } 
        }

        async function triggerVnAi(e) {
            if(e) e.stopPropagation(); showToast("AI æ€è€ƒä¸­...");
            const { cleanUrl, key, model } = saveApiSettingsInternal();
            if(!cleanUrl || !key) return alert("è¯·å…ˆé…ç½® API");
            const profile = JSON.parse(localStorage.getItem('chat_profile_'+interactId) || '{}');
            const history = getChatHistory(interactId).slice(-10);
            const contextMsgs = history.map(m => ({ role: m.role, content: m.content }));
            const historyText = history.map(m=>m.content).join("\n") + "\n" + (vnState.bgName || "");
            const wbPrompt = getWorldbookPrompt(interactId, historyText);
            const sysPrompt = `Persona: ${profile.aiPersona || 'Friend'}.
Current Outfit: ${vnState.outfit}. Current Location/Scene: ${vnState.bgName || 'Unknown'}.
${wbPrompt}
Response Style: Visual Novel. IMPORTANT: Split separate thoughts with "/n".
Instructions: Add tag (face:smile) or (face:angry) at start of line to change expression.`;
            const msgs = [{ role: "system", content: sysPrompt }, ...contextMsgs];
            try {
                const r = await fetch(`${cleanUrl}/chat/completions`, {method:'POST',headers:{'Authorization':`Bearer ${key}`,'Content-Type':'application/json'},body:JSON.stringify({model:model||"gpt-3.5-turbo",messages:msgs})});
                if(r.ok) {
                    const d = await r.json(); const txt = d.choices?.[0]?.message?.content || "...";
                    let parts = txt.split(/\/n/g).map(p => p.trim()).filter(p => p);
                    if (parts.length === 1 && txt.length > 50) parts = txt.match(/[^ã€‚ï¼Ÿï¼.?!]+[ã€‚ï¼Ÿï¼.?!]+/g) || [txt];
                    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    parts.forEach(part => { const cleanContent = part.replace(/\(face:[^)]+\)\s*/gi, '').trim(); if(cleanContent) saveChatMessage(interactId, {role:'assistant', type:'text', content:cleanContent, time:time}); });
                    vnQueue = parts; const chatList = JSON.parse(localStorage.getItem('chat_list_data')||'[]'); const target = chatList.find(c=>c.id==interactId); document.getElementById('vnName').innerText = target ? target.name : '???'; nextVnLine();
                }
            } catch(e) { console.error(e); alert("ç½‘ç»œé”™è¯¯"); }
        }

        /* Utils */
        function safeSetText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }
        function safeSetSrc(id, src) { const el = document.getElementById(id); if(el) el.src = src; }
        function saveProfile() { if (!currentProfileId) return; try { const nameVal = document.getElementById('p_name').innerText.trim(); const coverSrc = document.getElementById('p_cover_img').src; const avatarSrc = document.getElementById('p_avatar_img').src; const list = JSON.parse(localStorage.getItem('chat_list_data')||'[]'); const idx = list.findIndex(c => c.id == currentProfileId); if (idx !== -1) { list[idx].name = nameVal; list[idx].avatar = avatarSrc; localStorage.setItem('chat_list_data', JSON.stringify(list)); } const profileData = JSON.parse(localStorage.getItem('chat_profile_' + currentProfileId) || '{}'); profileData.cover = coverSrc; profileData.userAvatar = document.getElementById('p_user_avatar_img').src; profileData.userPersona = document.getElementById('p_user_persona').innerText; profileData.aiPersona = document.getElementById('p_ai_persona').innerText; ['gender','age','birth','job','sign'].forEach(k => profileData[k] = document.getElementById('p_'+k).innerText); localStorage.setItem('chat_profile_' + currentProfileId, JSON.stringify(profileData)); showToast("âœ… èµ„æ–™å·²ä¿å­˜"); renderChatList(); renderFriendList(); } catch (e) { alert("âŒ ä¿å­˜å¤±è´¥"); } }
        
        // ğŸ”¥ å…¨é‡å¤‡ä»½é€»è¾‘
        function exportData() { 
            const data = {}; 
            for(let i=0; i<localStorage.length; i++) { 
                const key = localStorage.key(i); 
                data[key] = localStorage.getItem(key); 
            } 
            const blob = new Blob([JSON.stringify(data)], {type: "application/octet-stream"}); 
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = `kawaii_full_backup_${new Date().toISOString().slice(0,10)}.json`; 
            document.body.appendChild(a); a.click(); document.body.removeChild(a); 
        }
        
        // ğŸ”¥ å…¨é‡å¯¼å…¥é€»è¾‘
        function importData(input) { 
            if(!input.files[0]) return; 
            const r = new FileReader(); 
            r.onload = async e => { 
                try { 
                    const data = JSON.parse(e.target.result); 
                    if(await Modal.show('confirm-danger','æ¢å¤å¤‡ä»½?','è¿™ä¼šè¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®å¹¶åˆ·æ–°é¡µé¢')) { 
                        localStorage.clear(); 
                        for(let k in data) localStorage.setItem(k, data[k]); 
                        location.reload(); 
                    } 
                } catch(e) { alert("æ–‡ä»¶æ ¼å¼é”™è¯¯"); } 
            }; 
            r.readAsText(input.files[0]); input.value=''; 
        }
        
        async function forceClearData() { if(await Modal.show('confirm-danger', 'æ¸…ç©ºæ•°æ®ï¼Ÿ')) { localStorage.clear(); location.reload(); } }
        function openSettingsApp() { document.getElementById('settingsApp').classList.add('active'); document.getElementById('desktop').classList.add('pushed'); }
        function closeSettingsApp() { document.getElementById('settingsApp').classList.remove('active'); document.getElementById('desktop').classList.remove('pushed'); }
        function openApiApp() { document.getElementById('apiSettingsApp').classList.add('active'); document.getElementById('desktop').classList.add('pushed'); }
        function closeApiApp() { document.getElementById('apiSettingsApp').classList.remove('active'); document.getElementById('desktop').classList.remove('pushed'); }
        function openChatListApp() { switchTab('msg'); document.getElementById('chatListApp').classList.add('active'); document.getElementById('desktop').classList.add('pushed'); renderChatList(); }
        function closeChatListApp() { document.getElementById('chatListApp').classList.remove('active'); document.getElementById('desktop').classList.remove('pushed'); }
        function switchTab(tab) { const msgList = document.getElementById('chatListContainer'); const friendList = document.getElementById('friendListContainer'); const tabMsg = document.getElementById('tab-msg'); const tabFriend = document.getElementById('tab-friend'); if(tab === 'msg') { msgList.style.display = 'block'; friendList.style.display = 'none'; tabMsg.classList.add('active'); tabFriend.classList.remove('active'); renderChatList(); } else { msgList.style.display = 'none'; friendList.style.display = 'block'; tabMsg.classList.remove('active'); tabFriend.classList.add('active'); renderFriendList(); } }
        function renderFriendList() { const c=document.getElementById('friendListContainer'); const l=JSON.parse(localStorage.getItem('chat_list_data')||'[]'); let h=''; l.forEach(chat=>{h+=`<div class="chat-item" onclick="openProfile('${chat.id}')"><div class="chat-avatar"><img src="${chat.avatar}"></div><div class="chat-content"><div class="chat-name">${chat.name}</div><div class="friend-bio">ç‚¹å‡»æŸ¥çœ‹èµ„æ–™</div></div></div>`;}); c.innerHTML=h; }
        function openProfile(id) { if(!id)return; currentProfileId=id; const l=JSON.parse(localStorage.getItem('chat_list_data')||'[]'); const chat=l.find(c=>c.id==id); const p=JSON.parse(localStorage.getItem('chat_profile_'+id)||'{}'); safeSetSrc('p_cover_img', p.cover||'https://via.placeholder.com/600x300'); safeSetSrc('p_avatar_img', chat.avatar); safeSetText('p_name', chat.name); ['gender','age','birth','job','sign'].forEach(k => safeSetText('p_'+k, p[k]||'')); safeSetText('p_ai_persona', p.aiPersona||''); safeSetText('p_user_persona', p.userPersona||''); safeSetSrc('p_user_avatar_img', p.userAvatar||document.getElementById('avatarImg').src); renderWorldbookTags(p.worldbook_ids); document.getElementById('profileApp').classList.add('active'); }
        function closeProfile() { document.getElementById('profileApp').classList.remove('active'); }
        function goToChat() { if(!currentProfileId)return; const l=JSON.parse(localStorage.getItem('chat_list_data')||'[]'); const idx=l.findIndex(c=>c.id==currentProfileId); if(idx!==-1){ if(l[idx].hidden){l[idx].hidden=false;localStorage.setItem('chat_list_data',JSON.stringify(l));} document.getElementById('profileApp').classList.remove('active'); setTimeout(() => openChatWindow(l[idx].id, l[idx].name, l[idx].avatar), 100); } }
        function openChatWindow(id, name, avatar) { activeChatId=id; activeChatName=name; activeChatAvatar=avatar; safeSetText('chatTitleName', name); const bg=localStorage.getItem('chat_bg_'+id); document.getElementById('chatMessages').style.backgroundImage=bg?`url(${bg})`:'none'; exitSelectionMode(); renderChatMessages(); document.getElementById('chatWindowApp').classList.add('active'); setTimeout(scrollToBottom,300); }
        function closeChatWindow() { document.getElementById('chatWindowApp').classList.remove('active'); activeChatId=null; renderChatList(); }
        function handleLongPress(index) { isSelectionMode=true; document.getElementById('chatWindowApp').classList.add('selection-mode'); toggleSelection(index); }
        function toggleSelection(index) { if(!isSelectionMode)return; const el=document.getElementById('msg-'+index); const safeIdx=Number(index); if(selectedIndices.has(safeIdx)){selectedIndices.delete(safeIdx);el.classList.remove('selected');}else{selectedIndices.add(safeIdx);el.classList.add('selected');} document.getElementById('selectCount').innerText=selectedIndices.size; if(selectedIndices.size===0)exitSelectionMode(); }
        function exitSelectionMode() { isSelectionMode=false; selectedIndices.clear(); document.getElementById('chatWindowApp').classList.remove('selection-mode'); document.querySelectorAll('.msg-row.selected').forEach(e=>e.classList.remove('selected')); }
        function renderChatMessages() { const c=document.getElementById('chatMessages'); c.innerHTML=''; const h=getChatHistory(activeChatId); h.forEach((m,i)=>appendMessageToUI(m,i)); }
        function scrollToBottom() { const c=document.getElementById('chatMessages'); c.scrollTop=c.scrollHeight; }
        function handleEnter(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendUserMessage();} }
        async function sendUserMessage() { const i=document.getElementById('chatInput'); const t=i.value.trim(); if(!t)return; i.value=''; const time=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); const m={role:'user',type:'text',content:t,time:time}; saveChatMessage(activeChatId,m); appendMessageToUI(m,-1); }
        function getChatHistory(id) { return JSON.parse(localStorage.getItem('chat_history_'+id)||'[]'); }
        function updateChatListPreview(id,c,t) { const l=JSON.parse(localStorage.getItem('chat_list_data')||'[]'); const i=l.findIndex(x=>x.id==id); if(i!==-1){l[i].lastMsg=c;l[i].time=t;l[i].hidden=false;localStorage.setItem('chat_list_data',JSON.stringify(l));renderChatList();} }
        function compressAndSave(i, id, k, prev, format = 'image/jpeg') { if (i.files[0]) { const r = new FileReader(); r.onload = e => { const img = new Image(); img.src = e.target.result; img.onload = () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); let w = img.width, h = img.height; const max = id && id.includes('icon') ? 200 : 800; if (w > h && w > max) { h *= max/w; w = max } else if (h > max) { w *= max/h; h = max }; c.width = w; c.height = h; ctx.drawImage(img, 0, 0, w, h); const d = c.toDataURL(format, 0.7); try { if (k) localStorage.setItem(k, d); if (id) { const el = document.getElementById(id); if(el.tagName === 'IMG') el.src = d; else el.innerHTML = `<img src="${d}">`; if (id === 'coverImg') document.getElementById('coverHint').style.display = 'none'; } if (prev) document.getElementById(prev).innerHTML = `<img src="${d}">`; showToast("å·²ä¿å­˜"); } catch (e) { alert("å›¾ç‰‡å¤ªå¤§ï¼Œå­˜å‚¨å¤±è´¥"); } } }; r.readAsDataURL(i.files[0]); i.value = ''; } }
        function loadProfileImg(i,id) { compressAndSave(i,id,null); }
        function setupTextSaver(id) { document.getElementById(id).addEventListener('input',function(){localStorage.setItem(id,this.innerText);}); }
        function loadText(id) { const v=localStorage.getItem(id);if(v)document.getElementById(id).innerText=v; }
        function loadSavedImg(k,t,b) { const d=localStorage.getItem(k);if(d){const el=document.getElementById(t);el.src=d;if(b)el.style.display='block';if(t==='coverImg')document.getElementById('coverHint').style.display='none';} }
        function loadSavedIcon(k,t,p) { const d=localStorage.getItem(k);if(d){document.getElementById(t).innerHTML=`<img src="${d}">`;if(p)document.getElementById(p).innerHTML=`<img src="${d}">`;} }
        function applyFont() { const u=document.getElementById('fontUrlInput').value.trim();if(u){new FontFace('C',`url(${u})`).load().then(f=>{document.fonts.add(f);document.documentElement.style.setProperty('--main-font','C,sans-serif');localStorage.setItem('custom_font_url',u);showToast("å·²åº”ç”¨");});} }
        function loadCustomFont() { const u=localStorage.getItem('custom_font_url');if(u)new FontFace('C',`url(${u})`).load().then(f=>{document.fonts.add(f);document.documentElement.style.setProperty('--main-font','C,sans-serif');}); }
        function loadWallpaper() { const d=localStorage.getItem('save_wallpaper');if(d)document.body.style.backgroundImage=`url(${d})`; }
        function initMockChats() { if(!localStorage.getItem('chat_list_data')){localStorage.setItem('chat_list_data',JSON.stringify([{id:'c1',name:'AIåŠ©æ‰‹',avatar:'https://ui-avatars.com/api/?name=AI&background=007aff&color=fff',lastMsg:'ä½ å¥½',time:'12:00'}]));} }
        function saveApiSettingsUI() { saveApiSettingsInternal();showToast("API å·²ä¿å­˜"); }
        function saveApiSettingsInternal() { const u=document.getElementById('api_url').value.trim().replace(/\/+$/,"");const k=document.getElementById('api_key').value.trim();const m=document.getElementById('api_model').value.trim();localStorage.setItem('gpt_url',u);localStorage.setItem('gpt_key',k);localStorage.setItem('gpt_model',m);return{cleanUrl:u,key:k,model:m}; }
        function loadApiSettings() { document.getElementById('api_url').value=localStorage.getItem('gpt_url')||'';document.getElementById('api_key').value=localStorage.getItem('gpt_key')||'';document.getElementById('api_model').value=localStorage.getItem('gpt_model')||''; }
        function clearData() { Modal.show('confirm-danger','æ¸…ç©ºæ•°æ®ï¼Ÿ').then(r=>{if(r){localStorage.clear();location.reload();}}); }
        function trigger(id) { document.getElementById(id).click(); }
        async function fetchModels() { const { cleanUrl, key } = saveApiSettingsInternal(); if (!cleanUrl || !key) return showToast("è¯·å…ˆå¡«å†™é…ç½®"); const statusEl = document.getElementById('fetch_status'); statusEl.innerText = "è·å–ä¸­..."; try { const res = await fetch(`${cleanUrl}/models`, { headers: { 'Authorization': `Bearer ${key}` } }); if (res.ok) { const data = await res.json(); const select = document.getElementById('model_select'); select.innerHTML = '<option value="">-- é€‰æ‹©æ¨¡å‹ --</option>'; const list = data.data || data; if(Array.isArray(list)) { list.forEach(m => { const opt = document.createElement('option'); opt.value = m.id; opt.innerText = m.id; select.appendChild(opt); }); document.getElementById('model_selector_row').style.display = 'flex'; statusEl.innerText = "âœ… æˆåŠŸ"; } } else { statusEl.innerText = "âŒ å¤±è´¥ " + res.status; } } catch (e) { statusEl.innerText = "âŒ ç½‘ç»œé”™è¯¯"; } }
        async function testConnection() { const { cleanUrl, key, model } = saveApiSettingsInternal(); const resBox = document.getElementById('test_result'); resBox.innerText = "æ­£åœ¨è¿æ¥..."; if (!cleanUrl || !key) { resBox.innerText = "âŒ è¯·å…ˆå®Œå–„é…ç½®"; return; } try { const res = await fetch(`${cleanUrl}/chat/completions`, { method: 'POST', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model: model || "gpt-3.5-turbo", messages: [{ role: "user", content: "Hi" }], max_tokens: 5 }) }); if (res.ok) { resBox.innerText = "âœ… è¿æ¥æˆåŠŸ"; showToast("è¿æ¥æˆåŠŸ"); } else { const err = await res.text(); resBox.innerText = `âŒ å¤±è´¥ (${res.status}): ${err.slice(0, 100)}`; } } catch (e) { resBox.innerText = "âŒ é”™è¯¯: " + e.message; } }
    </script>
</body>
</html>