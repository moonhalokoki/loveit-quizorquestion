<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kawaii OS æ•°æ®æ•‘æ´</title>
    <style>
        body { margin: 0; padding: 20px; font-family: sans-serif; background: #ffeaf3; color: #333; text-align: center; }
        .rescue-box { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #ff3b30; }
        button { 
            display: block; width: 100%; padding: 15px; margin: 10px 0; 
            border: none; border-radius: 12px; font-size: 16px; font-weight: bold; 
            color: white; cursor: pointer; 
        }
        .btn-scan { background: #007aff; }
        .btn-download { background: #34c759; }
        .log-area { 
            width: 100%; height: 200px; background: #222; color: #0f0; 
            font-family: monospace; padding: 10px; text-align: left; 
            overflow-y: scroll; border-radius: 10px; font-size: 12px;
        }
        img { max-width: 100px; max-height: 100px; border: 1px solid #ddd; margin: 5px; display: none; }
    </style>
</head>
<body>

    <div class="rescue-box">
        <h1>ğŸš‘ æ•°æ®æ•‘æ´æ¨¡å¼</h1>
        <p>iOS PWA ä¸“ç”¨ä¿®å¤å·¥å…·</p>
        
        <div id="status">å‡†å¤‡å°±ç»ª...</div>

        <!-- è¿™é‡Œæ˜¾ç¤ºæ‰¾å›çš„å›¾ç‰‡ï¼Œè¯æ˜æ•°æ®è¿˜åœ¨ -->
        <div id="preview-area">
            <p>æ‰¾å›çš„å›¾ç‰‡é¢„è§ˆï¼š</p>
            <img id="p_cover" alt="å°é¢">
            <img id="p_avatar" alt="å¤´åƒ">
            <img id="p_bg" alt="èƒŒæ™¯">
        </div>

        <button class="btn-scan" onclick="scanDatabase()">1. æ‰«æå¹¶ä¿®å¤æ•°æ®åº“è¿æ¥</button>
        <button class="btn-download" onclick="exportFullData()">2. å¯¼å‡ºæ‰€æœ‰æ•°æ® (å¤‡ä»½)</button>
    </div>

    <div class="log-area" id="console-log"></div>

    <script>
        // æ¨¡æ‹Ÿæ§åˆ¶å°è¾“å‡ºåˆ°å±å¹•
        function log(msg) {
            const area = document.getElementById('console-log');
            const p = document.createElement('div');
            p.innerText = `> ${msg}`;
            area.appendChild(p);
            area.scrollTop = area.scrollHeight;
            document.getElementById('status').innerText = msg;
        }

        const DB_NAME = "KawaiiOS_Assets";
        const STORE_NAME = "images";

        // 1. æ‰«ææ•°æ®åº“å¹¶ä¿®å¤ LocalStorage ç´¢å¼•
        function scanDatabase() {
            log("å¼€å§‹è¿æ¥æ•°æ®åº“...");
            const request = indexedDB.open(DB_NAME);

            request.onerror = (e) => {
                log("âŒ æ‰“å¼€æ•°æ®åº“å¤±è´¥: " + e.target.error);
                alert("æ— æ³•è¯»å–æ•°æ®åº“ï¼Œè¯·ç¡®è®¤ä½ æ˜¯å¦åœ¨åŒä¸€ä¸ªPWAåº”ç”¨å†…æ‰“å¼€ã€‚");
            };

            request.onsuccess = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    log("âŒ æ•°æ®åº“æ˜¯ç©ºçš„ (æ²¡æœ‰ images è¡¨)");
                    return;
                }

                const transaction = db.transaction([STORE_NAME], "readonly");
                const store = transaction.objectStore(STORE_NAME);
                const countReq = store.count();

                countReq.onsuccess = () => {
                    log(`ğŸ“Š æ•°æ®åº“ä¸­å‘ç° ${countReq.result} ä¸ªæ–‡ä»¶`);
                    if(countReq.result > 0) {
                        restoreKeys(db);
                    } else {
                        log("âš ï¸ æ•°æ®åº“æ˜¯ç©ºçš„ï¼Œæ•°æ®å¯èƒ½å·²ä¸¢å¤±ã€‚");
                    }
                };
            };
        }

        // æ¢å¤ Key å¹¶é¢„è§ˆå›¾ç‰‡
        function restoreKeys(db) {
            const transaction = db.transaction([STORE_NAME], "readonly");
            const store = transaction.objectStore(STORE_NAME);
            const cursorReq = store.openCursor();

            log("ğŸ”„ æ­£åœ¨é‡å»ºç´¢å¼•...");

            cursorReq.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const key = cursor.key;
                    const val = cursor.value;

                    log(`å‘ç°: ${key} (${(val.length/1024).toFixed(1)}KB)`);

                    // é¢„è§ˆå›¾ç‰‡ï¼Œç¡®è®¤æ•°æ®å­˜åœ¨
                    if (key === 'save_cover') document.getElementById('p_cover').src = val;
                    if (key === 'save_avatar') document.getElementById('p_avatar').src = val;
                    if (key === 'save_body') document.getElementById('p_bg').src = val;

                    // å…³é”®ä¿®å¤æ­¥éª¤ï¼š
                    // æ—§ç‰ˆæœ¬ä»£ç å¦‚æœå‘ç° LocalStorage é‡Œæ²¡æœ‰ keyï¼Œå°±ä¸ä¼šå» DB è¯»ã€‚
                    // æ‰€ä»¥æˆ‘ä»¬è¦åœ¨ LocalStorage é‡Œå†™ä¸€ä¸ªå ä½ç¬¦ï¼Œéª—æ—§ç‰ˆæœ¬å» DB è¯»ã€‚
                    // æˆ–è€…ï¼Œå¦‚æœä¸æƒ³ä¾èµ– DBï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ•°æ®å†™å› LocalStorage (å¦‚æœä¸å¤ªå¤§çš„è¯)ã€‚
                    // è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨æœ€ç¨³å¦¥çš„æ–¹å¼ï¼šä¿®å¤ LocalStorage æ ‡è®°ã€‚
                    
                    if (!localStorage.getItem(key)) {
                        localStorage.setItem(key, "RECOVERED_BY_TOOL");
                        log(`ğŸ›  å·²ä¿®å¤ç´¢å¼•: ${key}`);
                    }

                    document.querySelectorAll('img').forEach(img => {
                        if(img.src) img.style.display = 'inline-block';
                    });

                    cursor.continue();
                } else {
                    log("âœ… æ‰«æå®Œæˆï¼æ‰€æœ‰å›¾ç‰‡é“¾æ¥å·²ä¿®å¤ã€‚");
                    alert("æ‰«æå®Œæˆï¼\nå›¾ç‰‡åº”è¯¥å·²ç»å›æ¥äº†ã€‚\nå»ºè®®ç‚¹å‡»ä¸‹æ–¹ã€å¯¼å‡ºæ‰€æœ‰æ•°æ®ã€‘ä¸‹è½½å¤‡ä»½ã€‚\nç„¶åä½ å¯ä»¥æŠŠä»£ç æ”¹å›æ—§ç‰ˆæœ¬äº†ã€‚");
                }
            };
        }

        // 2. å¯¼å‡ºæ‰€æœ‰æ•°æ® (LocalStorage + IndexedDB)
        async function exportFullData() {
            log("ğŸ“¦ æ­£åœ¨æ‰“åŒ…æ•°æ®...");
            const backup = {};

            // 1. è·å– LocalStorage æ–‡æœ¬æ•°æ®
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                backup[k] = localStorage.getItem(k);
            }

            // 2. è·å– IndexedDB å›¾ç‰‡æ•°æ®
            const request = indexedDB.open(DB_NAME);
            request.onsuccess = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    downloadFile(backup);
                    return;
                }
                
                const tx = db.transaction([STORE_NAME], "readonly");
                const store = tx.objectStore(STORE_NAME);
                
                store.getAllKeys().onsuccess = (ev) => {
                    const keys = ev.target.result;
                    let processed = 0;
                    
                    if (keys.length === 0) {
                        downloadFile(backup);
                        return;
                    }

                    keys.forEach(key => {
                        store.get(key).onsuccess = (res) => {
                            // å°† DB æ•°æ®ç›´æ¥å†™å…¥ JSONï¼Œç¡®ä¿å¤‡ä»½æ˜¯å®Œæ•´çš„
                            backup[key] = res.target.result;
                            processed++;
                            if (processed === keys.length) {
                                downloadFile(backup);
                            }
                        };
                    });
                };
            };
        }

        function downloadFile(data) {
            const fileName = `KAWAII_RESCUE_${new Date().getTime()}.json`;
            const jsonStr = JSON.stringify(data);
            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.innerText = "ç‚¹å‡»è¿™é‡Œä¸‹è½½å¤‡ä»½æ–‡ä»¶";
            a.style.display = "block";
            a.style.fontSize = "20px";
            a.style.padding = "20px";
            a.style.background = "#fff";
            a.style.marginTop = "20px";
            
            document.querySelector('.rescue-box').appendChild(a);
            
            // iOS Safari è‡ªåŠ¨ç‚¹å‡»å¯èƒ½è¢«æ‹¦æˆªï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»
            log("âœ… æ‰“åŒ…å®Œæˆï¼è¯·ç‚¹å‡»ä¸‹æ–¹å‡ºç°çš„é“¾æ¥ä¸‹è½½ã€‚");
            alert("å¤‡ä»½æ‰“åŒ…å®Œæˆï¼\nè¯·ç‚¹å‡»é¡µé¢åº•éƒ¨å‡ºç°çš„é“¾æ¥ï¼Œé€‰æ‹©â€œå­˜å‚¨åˆ°æ–‡ä»¶â€ã€‚");
        }
    </script>
</body>
</html>